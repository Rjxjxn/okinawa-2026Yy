<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>2026 沖繩旅遊小秘書 (V30救援)</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

    <style>
        body { background-color: #0f172a; color: #f1f5f9; font-family: sans-serif; -webkit-tap-highlight-color: transparent; }
        .pb-safe { padding-bottom: env(safe-area-inset-bottom); }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .fade-in { animation: fadeIn 0.5s ease-out; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        #error-display { display: none; position: fixed; inset: 0; background: #450a0a; color: #fecaca; z-index: 99999; padding: 20px; overflow: auto; font-family: monospace; white-space: pre-wrap; }
    </style>
    
    <!-- 1. 白屏守護程式 -->
    <script>
        window.onerror = function(msg, url, line) {
            const el = document.getElementById('error-display');
            if(el) {
                el.style.display = 'block';
                el.innerHTML += `⚠️ 發生錯誤:\n${msg}\nLine: ${line}\n\n`;
            }
        };
    </script>
</head>
<body class="pb-24">

    <!-- 錯誤顯示區 -->
    <div id="error-display"></div>

    <!-- 標頭 -->
    <div class="bg-slate-900/95 sticky top-0 z-30 border-b border-slate-700 shadow-md">
        <div class="max-w-3xl mx-auto px-4 py-3">
            <div class="flex justify-between items-center mb-2">
                <div>
                    <h1 id="app-title" class="text-xl font-bold flex items-center gap-2 text-white">
                        <i data-lucide="moon" class="text-yellow-400" width="24"></i> 2026 沖繩行
                    </h1>
                    <div class="flex items-center gap-3 mt-1 text-xs text-slate-400">
                        <span id="status-dot" class="text-slate-500">● 連線中...</span>
                        <span id="weather-info"></span>
                    </div>
                </div>
                <div class="flex gap-2">
                    <button onclick="app.exportCSV()" id="btn-export" class="hidden p-2 rounded-full bg-emerald-900 text-emerald-400 border border-emerald-700"><i data-lucide="download" width="16"></i></button>
                    <button onclick="app.toggleTool()" class="p-2 rounded-full bg-slate-800 text-slate-300 border border-slate-600"><i data-lucide="calculator" width="16"></i></button>
                </div>
            </div>
            <!-- 匯率計算機 -->
            <div id="tool-panel" class="hidden bg-slate-800 p-3 rounded-lg border border-slate-600 mt-2">
                <div class="flex gap-2">
                    <input type="number" id="c-jpy" oninput="app.calc('jpy')" placeholder="JPY" class="w-1/2 bg-slate-900 border-slate-600 rounded p-2 text-right text-white">
                    <input type="number" id="c-twd" oninput="app.calc('twd')" placeholder="TWD" class="w-1/2 bg-slate-900 border-slate-600 rounded p-2 text-right text-white">
                </div>
            </div>
        </div>
    </div>

    <!-- 內容區 -->
    <div id="main" class="max-w-3xl mx-auto px-3 py-4 space-y-4 min-h-[60vh]"></div>

    <!-- 底部導航 -->
    <div class="fixed bottom-0 left-0 right-0 bg-slate-900 border-t border-slate-700 pb-safe z-40">
        <div class="flex justify-around max-w-3xl mx-auto text-[10px] py-2">
            <button onclick="app.setTab('itinerary')" id="nav-itinerary" class="flex-1 flex flex-col items-center gap-1 p-2 text-slate-500"><i data-lucide="calendar" width="20"></i>行程</button>
            <button onclick="app.setTab('backup')" id="nav-backup" class="flex-1 flex flex-col items-center gap-1 p-2 text-slate-500"><i data-lucide="folder-plus" width="20"></i>備案</button>
            <button onclick="app.setTab('recommend')" id="nav-recommend" class="flex-1 flex flex-col items-center gap-1 p-2 text-slate-500"><i data-lucide="thumbs-up" width="20"></i>推薦</button>
            <button onclick="app.setTab('split')" id="nav-split" class="flex-1 flex flex-col items-center gap-1 p-2 text-slate-500"><i data-lucide="divide-square" width="20"></i>分帳</button>
            <button onclick="app.setTab('accounting')" id="nav-accounting" class="flex-1 flex flex-col items-center gap-1 p-2 text-slate-500"><i data-lucide="wifi" width="20"></i>記帳</button>
        </div>
    </div>

    <!-- 主程式 -->
    <script>
        // 2. 資料設定
        const CONF = {
            fb: { apiKey: "AIzaSyBvclnyKUkCUzyBnGljSMsg38DfgroRDxg", authDomain: "okinawaonline-64b20.firebaseapp.com", projectId: "okinawaonline-64b20", storageBucket: "okinawaonline-64b20.firebasestorage.app", messagingSenderId: "457339726484", appId: "1:457339726484:web:686abfc9820d6d9c4b2281", measurementId: "G-7XV7V6QXBV" },
            users: [{id:'u1',n:'旅客A',c:'bg-blue-500'},{id:'u2',n:'旅客B',c:'bg-pink-500'},{id:'u3',n:'旅客C',c:'bg-amber-500'},{id:'u4',n:'旅客D',c:'bg-emerald-500'}],
            cats: [{id:'food',n:'餐飲',i:'utensils',c:'text-orange-400'},{id:'transport',n:'交通',i:'bus',c:'text-blue-400'},{id:'shopping',n:'購物',i:'shopping-bag',c:'text-pink-400'},{id:'ticket',n:'門票',i:'ticket',c:'text-purple-400'},{id:'hotel',n:'住宿',i:'home',c:'text-indigo-400'},{id:'other',n:'其他',i:'more-horizontal',c:'text-gray-400'}],
            days: [{d:"Day 1",t:"抵達&美國村"},{d:"Day 2",t:"浮潛&燒肉"},{d:"Day 3",t:"北部風光"},{d:"Day 4",t:"購物&唐吉訶德"},{d:"Day 5",t:"南部悠閒"},{d:"Day 6",t:"Outlet返台"}],
            rec: [{t:"美麗海水族館",tag:"北部"},{t:"古宇利島",tag:"北部"},{t:"美國村",tag:"中部"},{t:"萬座毛",tag:"中部"},{t:"國際通",tag:"南部"},{t:"瀨長島",tag:"南部"},{t:"暖暮拉麵",tag:"美食"},{t:"燒肉敘敘苑",tag:"美食"},{t:"Parco City",tag:"購物"},{t:"唐吉訶德",tag:"購物"}]
        };

        // 3. 應用程式核心
        window.app = {
            db: null,
            state: { tab:'itinerary', rate:4.65, users:[], expenses:[], itinerary:[], backup:[], split:{amt:'',payer:'u1',targets:[],curr:'JPY'}, form:{amt:'',note:'',curr:'JPY',cat:'food'} },
            
            init: function() {
                try {
                    this.state.users = JSON.parse(JSON.stringify(CONF.users));
                    this.state.split.targets = this.state.users.map(u=>u.id);
                    
                    if(typeof firebase !== 'undefined') {
                        firebase.initializeApp(CONF.fb);
                        this.db = firebase.firestore();
                        this.listen();
                    }
                    
                    this.render(); // 先畫介面
                    
                    // 抓匯率
                    fetch('https://api.exchangerate-api.com/v4/latest/TWD').then(r=>r.json()).then(d=>{if(d?.rates?.JPY)this.state.rate=d.rates.JPY;this.render();});
                    
                } catch(e) {
                    document.getElementById('error-display').style.display='block';
                    document.getElementById('error-display').innerText = e.message;
                }
            },

            listen: function() {
                const onOk = (ok) => { document.getElementById('status-dot').innerHTML = ok ? `<span class="text-emerald-400">● 連線成功</span>` : `<span class="text-red-400">● 離線</span>`; };
                
                this.db.collection('expenses').orderBy('timestamp','desc').onSnapshot(s=>{
                    this.state.expenses = []; s.forEach(d=>this.state.expenses.push({id:d.id,...d.data()}));
                    if(this.state.tab==='accounting' && document.activeElement.tagName!=='INPUT') this.render();
                    onOk(true);
                }, ()=>onOk(false));
                
                this.db.collection('itinerary_events').onSnapshot(s=>{
                    this.state.itinerary = []; s.forEach(d=>this.state.itinerary.push({id:d.id,...d.data()}));
                    if(this.state.tab==='itinerary') this.render();
                });

                this.db.collection('backup_events').orderBy('timestamp','desc').onSnapshot(s=>{
                    this.state.backup = []; s.forEach(d=>this.state.backup.push({id:d.id,...d.data()}));
                    if(this.state.tab==='backup') this.render();
                });
                
                this.db.collection('config').doc('users').onSnapshot(s=>{
                    if(s.exists) this.state.users = s.data().list;
                    if(this.state.tab==='accounting' || this.state.tab==='split') this.render();
                });
            },

            // --- 動作 ---
            setTab: function(t) { this.state.tab = t; this.render(); },
            toggleTool: function() { document.getElementById('tool-panel').classList.toggle('hidden'); },
            calc: function(t) { 
                const j=document.getElementById('c-jpy'), tw=document.getElementById('c-twd');
                if(t==='jpy') tw.value = (j.value/this.state.rate).toFixed(0);
                else j.value = (tw.value*this.state.rate).toFixed(0);
            },
            
            // --- 渲染 ---
            render: function() {
                this.renderNav();
                this.renderContent();
                lucide.createIcons();
                // 顯示/隱藏匯出按鈕
                document.getElementById('btn-export').classList.toggle('hidden', this.state.tab!=='accounting');
                // 更新標題
                const titles = {itinerary:'行程表', backup:'備案清單', recommend:'推薦景點', split:'智慧分帳', accounting:'旅費記帳'};
                document.getElementById('header-title').innerHTML = `<i data-lucide="${this.getIcon(this.state.tab)}" class="text-yellow-400" width="24"></i> ${titles[this.state.tab]}`;
            },
            
            getIcon: function(t) { return {itinerary:'calendar',backup:'folder-plus',recommend:'thumbs-up',split:'divide-square',accounting:'wifi'}[t]||'moon'; },

            renderNav: function() {
                ['itinerary','backup','recommend','split','accounting'].forEach(t => {
                    const btn = document.getElementById('nav-'+t);
                    if(btn) btn.className = this.state.tab===t ? "flex-1 flex flex-col items-center gap-1 p-2 text-indigo-400 transition-colors" : "flex-1 flex flex-col items-center gap-1 p-2 text-slate-600 transition-colors";
                });
            },

            renderContent: function() {
                const c = document.getElementById('main');
                c.innerHTML = '';
                const t = this.state.tab;
                if(t==='itinerary') this.renderItin(c);
                else if(t==='backup') this.renderBackup(c);
                else if(t==='recommend') this.renderRec(c);
                else if(t==='split') this.renderSplit(c);
                else this.renderAcc(c);
            },

            // --- 分頁內容 ---
            renderItin: function(c) {
                if(this.state.itinerary.length===0) {
                    c.innerHTML = `<div class="text-center py-10 text-slate-500"><p class="mb-4">尚無行程</p><button onclick="app.uploadDef()" class="bg-indigo-600 text-white px-4 py-2 rounded">載入預設行程</button></div>`;
                    return;
                }
                CONF.days.forEach((d,i) => {
                    const evs = this.state.itinerary.filter(e=>e.dayIndex===i).sort((a,b)=>a.time.localeCompare(b.time));
                    let h = `<div class="bg-slate-800 rounded-lg overflow-hidden border border-slate-700 mb-4"><div class="bg-slate-900/50 p-3 flex justify-between items-center"><span class="font-bold text-slate-200">${d.d} ${d.t}</span><button onclick="app.addItin(${i})" class="text-indigo-400"><i data-lucide="plus-circle" width="18"></i></button></div>`;
                    if(evs.length===0) h+=`<div class="p-3 text-center text-xs text-slate-500">無行程</div>`;
                    else {
                        evs.forEach(e => {
                            const map = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent("沖繩 "+e.title)}`;
                            h += `<div class="p-3 border-b border-slate-700/50 flex gap-3"><div class="text-emerald-400 font-mono text-sm pt-0.5">${e.time}</div><div class="flex-1"><div class="font-bold text-slate-200 text-sm">${e.title}</div><div class="text-xs text-slate-400 mt-1">${e.note||''}</div><div class="flex gap-2 mt-2"><a href="${map}" target="_blank" class="bg-indigo-900/50 text-indigo-300 px-2 py-1 rounded text-xs">導航</a><button onclick="app.delItin('${e.id}')" class="text-slate-600"><i data-lucide="trash-2" width="14"></i></button></div></div></div>`;
                        });
                    }
                    h += `</div>`;
                    c.innerHTML += h;
                });
            },

            renderBackup: function(c) {
                const list = this.state.backup.length===0 ? `<div class="text-center py-8 text-slate-500">無備案</div>` : this.state.backup.map(e => `
                    <div class="bg-slate-800 p-3 rounded-lg border border-slate-700 mb-2 flex gap-3">
                        <div class="flex-1"><div class="font-bold text-slate-200 text-sm">${e.title}</div><div class="text-xs text-slate-500">${e.note||''}</div></div>
                        <div class="flex gap-2 items-center">
                            <button onclick="app.pushItin('${e.id}','${e.title}','${e.note}')" class="bg-indigo-600 text-white px-2 py-1 rounded text-xs">排程</button>
                            <button onclick="app.delBackup('${e.id}')" class="text-red-400"><i data-lucide="trash-2" width="16"></i></button>
                        </div>
                    </div>`).join('');
                c.innerHTML = `<button onclick="app.addBackup()" class="w-full py-3 border border-dashed border-slate-600 rounded-lg text-slate-400 mb-4 hover:bg-slate-800">+ 新增備案</button>${list}`;
            },

            renderRec: function(c) {
                // Filter
                const fs = ['全部','北部','中部','南部','美食','購物'];
                const fc = fs.map(f=>`<button onclick="app.state.recommendFilter='${f}';app.render()" class="px-3 py-1 rounded-full text-xs ${this.state.recommendFilter===f?'bg-blue-600 text-white':'bg-slate-800 text-slate-400'}">${f}</button>`).join('');
                // List
                const spots = this.state.recommendFilter==='全部' ? CONF.rec : CONF.rec.filter(s=>s.tag.includes(this.state.recommendFilter));
                const list = spots.map(s => `
                    <div class="bg-slate-800 p-3 rounded-lg border border-slate-700 flex justify-between items-center">
                        <div><div class="font-bold text-slate-200 text-sm">${s.t}</div><div class="text-xs text-blue-400">${s.tag}</div></div>
                        <div class="flex gap-2">
                             <a href="https://www.google.com/maps/search/?api=1&query=${encodeURIComponent("沖繩 "+s.t)}" target="_blank" class="bg-slate-700 text-slate-300 p-1.5 rounded"><i data-lucide="search" width="14"></i></a>
                             <button onclick="app.addBackupFromRec('${s.t}','${s.tag}')" class="bg-blue-600 text-white p-1.5 rounded"><i data-lucide="plus" width="14"></i></button>
                        </div>
                    </div>`).join('');
                c.innerHTML = `<div class="flex gap-2 overflow-x-auto pb-2 mb-2 hide-scrollbar">${fc}</div><div class="grid grid-cols-2 gap-2">${list}</div>`;
            },

            renderSplit: function(c) {
                const s = this.state.split;
                const isTwd = s.curr === 'TWD';
                let res = '';
                if(s.amount && s.targets.length>0) {
                    const per = Math.round(parseFloat(s.amount)/s.targets.length);
                    const sym = isTwd ? 'NT$' : '¥';
                    const payer = this.state.users.find(u=>u.id===s.payer);
                    const debt = s.targets.filter(id=>id!==s.payer).map(id=>{
                        const u = this.state.users.find(x=>x.id===id);
                        return `<div class="flex justify-between text-xs py-1 border-b border-white/10"><span>${u.name} 給 ${payer.name}</span><span class="text-amber-400">${sym}${per}</span></div>`;
                    }).join('');
                    res = `<div class="bg-amber-900/30 border border-amber-600/50 rounded-xl p-4 mt-4"><div class="text-center text-xs text-amber-200/70 mb-1">每人應付</div><div class="text-center text-2xl font-bold text-amber-400 mb-3">${sym}${per}</div><div class="mb-3">${debt||'<div class="text-center text-xs text-slate-400">自己付</div>'}</div><button onclick="app.saveSplit(${per})" class="w-full bg-amber-600 text-white py-2 rounded font-bold">寫入記帳</button></div>`;
                }

                c.innerHTML = `
                    <div class="bg-slate-800 rounded-xl p-4 border border-slate-700">
                        <div class="flex gap-2 mb-4">
                            <input type="number" id="sp-amt" value="${s.amount}" oninput="app.updSplit(this.value)" class="w-2/3 bg-slate-900 border-slate-600 rounded p-3 text-xl text-center text-white" placeholder="總金額">
                            <div class="w-1/3 flex bg-slate-900 rounded border border-slate-600 p-1">
                                <button onclick="app.setSplitCurr('JPY')" class="flex-1 rounded text-xs ${!isTwd?'bg-amber-600 text-white':'text-slate-400'}">JPY</button>
                                <button onclick="app.setSplitCurr('TWD')" class="flex-1 rounded text-xs ${isTwd?'bg-indigo-600 text-white':'text-slate-400'}">TWD</button>
                            </div>
                        </div>
                        <div class="space-y-3">
                            <div><div class="text-xs text-slate-400 mb-1">付款人</div><div class="flex gap-2 overflow-x-auto pb-1">${this.state.users.map(u=>`<button onclick="app.setSplitPayer('${u.id}')" class="px-3 py-2 rounded text-xs whitespace-nowrap ${s.payer===u.id?`${u.color} text-white`:'bg-slate-700 text-slate-400'}">${u.name}</button>`).join('')}</div></div>
                            <div><div class="text-xs text-slate-400 mb-1">分給誰</div><div class="grid grid-cols-2 gap-2">${this.state.users.map(u=>{const sel=s.targets.includes(u.id);return `<button onclick="app.togSplitTarget('${u.id}')" class="py-2 rounded text-xs border ${sel?'bg-slate-600 text-white border-amber-500':'bg-slate-700 text-slate-500 border-transparent'}">${u.name} ${sel?'✓':''}</button>`}).join('')}</div></div>
                        </div>
                        ${res}
                    </div>
                `;
                // Keep focus
                const inp = document.getElementById('sp-amt'); if(inp && document.activeElement!==inp && s.amount) { inp.focus(); }
            },

            renderAcc: function(c) {
                const total = this.state.expenses.reduce((a,b)=>a+b.amount,0);
                const isJpy = this.state.form.curr === 'JPY';
                
                // Form
                const form = `
                    <div class="bg-slate-800 rounded-xl p-4 border border-slate-700 mb-4">
                        <div class="flex gap-2 mb-3 bg-slate-900 p-1 rounded">${this.state.users.map(u=>`<button onclick="app.setFormUser('${u.id}')" class="flex-1 py-1 text-xs rounded ${this.state.form.payer===u.id?`${u.color} text-white`:'text-slate-500'}">${u.name}</button>`).join('')}</div>
                        <div class="flex gap-2 mb-3">
                            <input type="number" id="acc-amt" value="${this.state.form.amt}" oninput="app.setFormAmt(this.value)" placeholder="0" class="w-2/3 bg-slate-900 border-slate-600 rounded p-2 text-white text-lg">
                            <div class="w-1/3 flex bg-slate-900 rounded border border-slate-600 p-1">
                                <button onclick="app.setFormCurr('JPY')" class="flex-1 text-xs rounded ${isJpy?'bg-emerald-600 text-white':'text-slate-400'}">JPY</button>
                                <button onclick="app.setFormCurr('TWD')" class="flex-1 text-xs rounded ${!isJpy?'bg-indigo-600 text-white':'text-slate-400'}">TWD</button>
                            </div>
                        </div>
                        <div class="grid grid-cols-6 gap-1 mb-3">${CONF.cats.map(x=>`<button onclick="app.setFormCat('${x.id}')" class="flex flex-col items-center gap-1 p-1 rounded ${this.state.form.cat===x.id?'bg-slate-700 ring-1 ring-emerald-500':''}"><i data-lucide="${x.i}" class="${x.c}" width="16"></i><span class="text-[9px] text-slate-400">${x.n}</span></button>`).join('')}</div>
                        <div class="flex gap-2"><input value="${this.state.form.note}" oninput="app.setFormNote(this.value)" placeholder="備註..." class="flex-1 bg-slate-900 border-slate-600 rounded px-3 text-sm text-white"><button onclick="app.submitExp()" class="bg-emerald-600 text-white p-2.5 rounded shadow"><i data-lucide="plus" width="20"></i></button></div>
                    </div>
                `;

                // List
                const list = this.state.expenses.map(e=>{
                    const u = this.state.users.find(x=>x.id===e.userId)||CONF.users[0];
                    const cat = CONF.cats.find(x=>x.id===e.cat)||CONF.cats[0];
                    return `<div class="bg-slate-800 border-l-4 ${u.border} rounded mb-2 p-3 flex items-center gap-3 relative group">
                        <div class="flex-1"><div class="flex justify-between"><span class="text-sm font-bold text-slate-200">${e.note||cat.n}</span><span class="font-mono text-white">¥${e.amount}</span></div><div class="text-[10px] text-slate-500 flex justify-between mt-1"><span>${u.name}</span><span>≈ NT$${Math.round(e.amount/this.state.rate)}</span></div></div>
                        <button onclick="app.delExp('${e.id}')" class="text-red-400 opacity-50 hover:opacity-100"><i data-lucide="trash-2" width="14"></i></button>
                    </div>`;
                }).join('');

                c.innerHTML = `<div class="bg-slate-800 p-4 rounded-xl border border-slate-700 mb-4 flex justify-between items-center"><div><div class="text-2xl font-bold text-white">¥${total.toLocaleString()}</div><div class="text-xs text-slate-400">總計約 NT$${Math.round(total/this.state.rate).toLocaleString()}</div></div><div class="flex gap-1">${this.state.users.map(u=>`<div onclick="app.renameUser('${u.id}')" class="w-6 h-6 rounded-full ${u.color} flex items-center justify-center text-[10px] text-white font-bold cursor-pointer">${u.name[0]}</div>`).join('')}</div></div>${form}<div>${list}</div>`;
                
                // Focus
                const inp = document.getElementById('acc-amt'); if(inp && document.activeElement!==inp && this.state.form.amt) inp.focus();
            },

            // --- Ops ---
            uploadDef: function(){ if(confirm("上傳?")) { const b=this.db.batch(); const s=[{dayIndex:0,events:[{time:"09:20",title:"抵達",note:"取車",cost:"",imgKey:"airport",mapUrl:"機場"}]}]; /*Simplified*/ s.forEach(d=>{d.events.forEach(e=>{ b.set(this.db.collection('itinerary_events').doc(), {...e, dayIndex:d.dayIndex, timestamp:Date.now()}); })}); b.commit().then(()=>alert("OK")); } },
            addItin: function(d){ const t=prompt("時間(10:00)"); if(t){ const tt=prompt("標題"); if(tt) this.db.collection('itinerary_events').add({dayIndex:d, time:t, title:tt, note:prompt("備註")||'', cost:'', mapUrl:tt, imgKey:'default', timestamp:Date.now()}); }},
            delItin: function(id){ if(confirm("刪?")) this.db.collection('itinerary_events').doc(id).delete(); },
            addBackup: function(){ const t=prompt("名稱"); if(t) this.db.collection('backup_events').add({title:t, tag:'自訂', note:'', timestamp:Date.now()}); },
            addBackupFromRec: function(t,g){ if(confirm("加入?")) this.db.collection('backup_events').add({title:t, tag:g, note:'推薦', timestamp:Date.now()}); },
            delBackup: function(id){ if(confirm("刪?")) this.db.collection('backup_events').doc(id).delete(); },
            pushToItin: function(id,t,n){ const d=prompt("第幾天(1-6)?"); if(d){ const di=parseInt(d)-1; const tm=prompt("時間?"); this.db.collection('itinerary_events').add({dayIndex:di, time:tm||"10:00", title:t, note:n, cost:'', mapUrl:t, imgKey:'default', timestamp:Date.now()}); if(confirm("移除備案?")) this.db.collection('backup_events').doc(id).delete(); } },
            
            // Split Ops
            updSplit: function(v){ this.state.split.amount=v; this.render(); const e=document.getElementById('sp-amt'); if(e){e.focus();e.value=v;} },
            setSplitCurr: function(c){ this.state.split.curr=c; this.render(); },
            setSplitPayer: function(id){ this.state.split.payer=id; if(!this.state.split.targets.includes(id))this.state.split.targets.push(id); this.render(); },
            togSplitTarget: function(id){ const i=this.state.split.targets.indexOf(id); if(i>-1)this.state.split.targets.splice(i,1); else this.state.split.targets.push(id); this.render(); },
            saveSplit: function(per){ if(confirm("寫入?")){ const s=this.state.split; let v=parseFloat(s.amount); const ns=this.state.users.filter(u=>s.targets.includes(u.id)).map(u=>u.name).join(','); let n=`分帳: 總${s.curr==='TWD'?'NT$':'¥'}${v} (${ns})`; if(s.curr==='TWD')v=Math.round(v*this.state.rate); this.db.collection('expenses').add({amount:v, cat:'food', note:n, userId:s.payer, timestamp:Date.now()}); this.state.split.amount=''; alert("OK"); this.render(); } },

            // Acc Ops
            setFormUser: function(id){ this.state.form.payer=id; this.render(); },
            setFormCurr: function(c){ this.state.form.curr=c; this.render(); },
            setFormCat: function(c){ this.state.form.cat=c; this.render(); },
            setFormAmt: function(v){ this.state.form.amt=v; },
            setFormNote: function(v){ this.state.form.note=v; },
            submitExp: function(){ const f=this.state.form; if(!f.amt)return; let v=parseFloat(f.amt); if(f.curr==='TWD')v=Math.round(v*this.state.rate); this.db.collection('expenses').add({amount:v, cat:f.cat, note:f.note, userId:f.payer, timestamp:Date.now()}); this.state.form.amt=''; this.state.form.note=''; this.render(); },
            delExp: function(id){ if(confirm("刪?")) this.db.collection('expenses').doc(id).delete(); },
            renameUser: function(id){ const u=this.state.users.find(x=>x.id===id), n=prompt("新暱稱",u.name); if(n){ const l=this.state.users.map(x=>x.id===id?{...x,name:n}:x); this.db.collection('config').doc('users').set({list:l}); } },
            exportCSV: function(){
                let c="\uFEFF日期,人,項,日幣,台幣\n"; this.state.expenses.forEach(e=>{ c+=`${new Date(e.timestamp).toLocaleDateString()},${this.state.users.find(u=>u.id===e.userId)?.name},${CONF.cats.find(x=>x.id===e.cat)?.n},${e.amount},${Math.round(e.amount/this.state.rate)}\n`; });
                const l=document.createElement("a"); l.href=URL.createObjectURL(new Blob([c],{type:'text/csv'})); l.download="ok.csv"; l.click();
            }
        };

        window.onload = function() { app.init(); };
    </script>
</body>
</html>



    </script>
</body>
</html>


