<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>2026 æ²–ç¹©æ—…éŠå°ç§˜æ›¸ (V30æ•‘æ´)</title>
    
    <!-- 1. è¼‰å…¥ Tailwind (æ¨£å¼) -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 2. è¼‰å…¥ Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- 3. è¼‰å…¥ Firebase (æœ€ç©©å®šç‰ˆ) -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

    <style>
        body { background-color: #0f172a; color: #f1f5f9; font-family: sans-serif; touch-action: manipulation; }
        .pb-safe { padding-bottom: env(safe-area-inset-bottom); }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        
        /* éŒ¯èª¤é¡¯ç¤ºå™¨ */
        #error-box { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #450a0a; color: #fca5a5; z-index: 99999; padding: 20px; overflow: auto; font-family: monospace; white-space: pre-wrap; }
        
        /* è¼‰å…¥ç•«é¢ */
        #loading-screen { position: fixed; inset: 0; background: #0f172a; z-index: 9998; display: flex; justify-content: center; align-items: center; flex-direction: column; transition: opacity 0.5s; }
    </style>

    <!-- 4. éŒ¯èª¤æ””æˆªè…³æœ¬ (æœ€å„ªå…ˆåŸ·è¡Œ) -->
    <script>
        window.onerror = function(msg, url, line) {
            const box = document.getElementById('error-box');
            box.style.display = 'block';
            box.innerHTML += `ğŸ”´ ç™¼ç”ŸéŒ¯èª¤:\n${msg}\nLine: ${line}\n------------------\n`;
            // è©¦åœ–å¼·åˆ¶ç§»é™¤ Loading
            const load = document.getElementById('loading-screen');
            if(load) load.style.display = 'none';
        };
    </script>
</head>
<body class="pb-24">

    <!-- éŒ¯èª¤é¡¯ç¤ºå€ -->
    <div id="error-box"></div>

    <!-- è¼‰å…¥ä¸­ -->
    <div id="loading-screen">
        <div class="animate-spin text-emerald-500 mb-4"><i data-lucide="loader-2" width="48" height="48"></i></div>
        <div class="text-slate-400 text-sm">ç³»çµ±å•Ÿå‹•ä¸­...</div>
        <button onclick="document.getElementById('loading-screen').style.display='none'" class="mt-8 border border-slate-600 text-slate-500 px-4 py-2 rounded text-xs hover:text-white">å¼·åˆ¶é€²å…¥</button>
    </div>

    <!-- æ‡‰ç”¨ç¨‹å¼ä¸»é«” -->
    <div id="app">
        <!-- Header -->
        <div class="bg-[#1e293b]/95 backdrop-blur-md shadow-lg sticky top-0 z-30 border-b border-indigo-500/30">
            <div class="max-w-3xl mx-auto px-4 py-3">
                <div class="flex justify-between items-center mb-2">
                    <div>
                        <h1 id="app-title" class="text-lg md:text-2xl font-bold flex items-center gap-2 text-white">
                            <i data-lucide="moon" class="text-yellow-300" width="20"></i> 2026 æ²–ç¹©è¡Œ
                        </h1>
                        <div class="flex items-center gap-2 mt-1 overflow-x-auto hide-scrollbar">
                            <span id="weather-display" class="text-[10px] flex items-center gap-1 text-slate-300 bg-slate-800 px-2 py-0.5 rounded-full border border-slate-600 hidden"></span>
                            <span id="status-display" class="text-[10px] flex items-center gap-1 text-slate-500">
                                <div class="w-2 h-2 rounded-full bg-slate-500"></div> é€£ç·šä¸­...
                            </span>
                        </div>
                    </div>
                    <div class="flex gap-2">
                        <button id="btn-export" onclick="doExport()" class="hidden p-2 rounded-full bg-emerald-600/20 text-emerald-400 hover:bg-emerald-600 hover:text-white"><i data-lucide="download" width="18"></i></button>
                        <button onclick="toggleTool()" class="p-2 rounded-full bg-slate-700 text-slate-300 hover:text-white"><i data-lucide="calculator" width="18"></i></button>
                    </div>
                </div>
                <!-- è¨ˆç®—æ©Ÿ -->
                <div id="tool-panel" class="hidden bg-slate-800/90 rounded-lg p-3 border border-slate-600 mt-2">
                    <div class="flex items-center gap-2">
                        <div class="relative flex-1"><span class="absolute left-2 top-2 text-xs text-slate-400">JPY</span><input type="number" id="c-jpy" oninput="calc('jpy')" class="w-full bg-slate-900 border border-slate-600 rounded p-1.5 pt-6 text-right text-white"></div>
                        <i data-lucide="arrow-right-left" class="text-slate-500" width="16"></i>
                        <div class="relative flex-1"><span class="absolute left-2 top-2 text-xs text-slate-400">TWD</span><input type="number" id="c-twd" oninput="calc('twd')" class="w-full bg-slate-900 border border-slate-600 rounded p-1.5 pt-6 text-right text-white"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main View -->
        <div id="main-view" class="max-w-3xl mx-auto px-3 py-4 space-y-5 min-h-[50vh]"></div>
        
        <!-- Bottom Nav -->
        <div class="fixed bottom-0 left-0 right-0 bg-[#1e293b]/95 backdrop-blur-md border-t border-slate-700 pb-safe z-40">
            <div class="flex justify-around max-w-3xl mx-auto text-[10px]">
                <button onclick="setTab('itinerary')" id="nav-itinerary" class="flex-1 py-3 flex flex-col items-center gap-1 text-indigo-400"><i data-lucide="calendar" width="20"></i>è¡Œç¨‹</button>
                <button onclick="setTab('backup')" id="nav-backup" class="flex-1 py-3 flex flex-col items-center gap-1 text-slate-500"><i data-lucide="folder-plus" width="20"></i>å‚™æ¡ˆ</button>
                <button onclick="setTab('recommend')" id="nav-recommend" class="flex-1 py-3 flex flex-col items-center gap-1 text-slate-500"><i data-lucide="thumbs-up" width="20"></i>æ¨è–¦</button>
                <button onclick="setTab('split')" id="nav-split" class="flex-1 py-3 flex flex-col items-center gap-1 text-slate-500"><i data-lucide="divide-square" width="20"></i>åˆ†å¸³</button>
                <button onclick="setTab('accounting')" id="nav-accounting" class="flex-1 py-3 flex flex-col items-center gap-1 text-slate-500"><i data-lucide="wifi" width="20"></i>è¨˜å¸³</button>
            </div>
        </div>
    </div>

    <!-- 5. æ ¸å¿ƒç¨‹å¼ç¢¼ -->
    <script>
        // --- è¨­å®šèˆ‡ç‹€æ…‹ ---
        const CONFIG = {
            fb: { apiKey: "AIzaSyBvclnyKUkCUzyBnGljSMsg38DfgroRDxg", authDomain: "okinawaonline-64b20.firebaseapp.com", projectId: "okinawaonline-64b20", storageBucket: "okinawaonline-64b20.firebasestorage.app", messagingSenderId: "457339726484", appId: "1:457339726484:web:686abfc9820d6d9c4b2281", measurementId: "G-7XV7V6QXBV" },
            users: [{id:'u1',n:'æ—…å®¢A',c:'bg-blue-500'},{id:'u2',n:'æ—…å®¢B',c:'bg-pink-500'},{id:'u3',n:'æ—…å®¢C',c:'bg-amber-500'},{id:'u4',n:'æ—…å®¢D',c:'bg-emerald-500'}],
            cats: [{id:'food',n:'é¤é£²',i:'utensils',c:'text-orange-400'},{id:'transport',n:'äº¤é€š',i:'bus',c:'text-blue-400'},{id:'shopping',n:'è³¼ç‰©',i:'shopping-bag',c:'text-pink-400'},{id:'ticket',n:'é–€ç¥¨',i:'ticket',c:'text-purple-400'},{id:'hotel',n:'ä½å®¿',i:'home',c:'text-indigo-400'},{id:'other',n:'å…¶ä»–',i:'more-horizontal',c:'text-gray-400'}],
            days: [{d:"Day 1",t:"æŠµé”&ç¾åœ‹æ‘"},{d:"Day 2",t:"æµ®æ½›&ç‡’è‚‰"},{d:"Day 3",t:"åŒ—éƒ¨é¢¨å…‰"},{d:"Day 4",t:"è³¼ç‰©&å”å‰è¨¶å¾·"},{d:"Day 5",t:"å—éƒ¨æ‚ é–’"},{d:"Day 6",t:"Outletè¿”å°"}],
            rec: [
                {t:"ç¾éº—æµ·æ°´æ—é¤¨",g:"åŒ—éƒ¨",n:"å¿…çœ‹é»‘æ½®ä¹‹æµ·",i:"aquarium"},{t:"å¤å®‡åˆ©å³¶",g:"åŒ—éƒ¨",n:"å¿ƒå½¢å²©",i:"bridge"},{t:"å²¸æœ¬é£Ÿå ‚",g:"åŒ—éƒ¨",n:"ç™¾å¹´è€åº—",i:"food"},{t:"å‚™ç€¨ç¦æœ¨æ—é“",g:"åŒ—éƒ¨",n:"å–®è»Š",i:"sea"},
                {t:"ç¾åœ‹æ‘",g:"ä¸­éƒ¨",n:"é€›è¡—æ—¥è½",i:"village"},{t:"è¬åº§æ¯›",g:"ä¸­éƒ¨",n:"è±¡é¼»å²©",i:"sea"},{t:"æ¸¯å·å¤–äººä½å®…",g:"ä¸­éƒ¨",n:"æ–‡é’",i:"coffee"},{t:"æ°¸æ—ºå¤¢æ¨‚åŸ",g:"ä¸­éƒ¨",n:"æœ€å¤§",i:"shop"},
                {t:"åœ‹éš›é€š",g:"å—éƒ¨",n:"ç†±é¬§",i:"shop"},{t:"ç€¨é•·å³¶",g:"å—éƒ¨",n:"é£›æ©Ÿ",i:"sea"},{t:"ç‰æ³‰æ´",g:"å—éƒ¨",n:"é˜ä¹³çŸ³",i:"night"},{t:"ç³¸æ»¿é­šå¸‚å ´",g:"å—éƒ¨",n:"æµ·é®®",i:"market"},
                {t:"æš–æš®æ‹‰éºµ",g:"ç¾é£Ÿ",n:"æ’éšŠ",i:"food"},{t:"å‚‘å…‹ç‰›æ’",g:"ç¾é£Ÿ",n:"å¾©å¤",i:"food"},{t:"ç‡’è‚‰æ•˜æ•˜è‹‘",g:"ç¾é£Ÿ",n:"é«˜ç´š",i:"food"},{t:"å¹¸ç¦é¬†é¤…",g:"ç¾é£Ÿ",n:"é ç´„",i:"coffee"},
                {t:"å”å‰è¨¶å¾·",g:"è³¼ç‰©",n:"24H",i:"shop"},{t:"Parco City",g:"è³¼ç‰©",n:"ç™¾è²¨",i:"shop"},{t:"DFSå…ç¨…",g:"è³¼ç‰©",n:"ç²¾å“",i:"shop"},{t:"å¤§åœ‹è—¥å¦",g:"è³¼ç‰©",n:"ä¾¿å®œ",i:"shop"}
            ]
        };

        // ç‹€æ…‹è®Šæ•¸ (State)
        let APP = {
            tab: 'itinerary', rate: 4.65, users: [], expenses: [], itinerary: [], backup: [],
            split: { amt:'', payer:'u1', targets:[], curr:'JPY' },
            form: { amt:'', note:'', curr:'JPY', cat:'food', payer:'u1' },
            expandedId: null, recFilter: 'å…¨éƒ¨'
        };

        // --- å•Ÿå‹• ---
        window.onload = function() {
            setTimeout(() => { 
                const l = document.getElementById('loading-screen');
                if(l) { l.style.opacity = '0'; setTimeout(()=>l.style.display='none', 500); }
            }, 1500);

            try {
                if(typeof firebase !== 'undefined') {
                    firebase.initializeApp(CONFIG.fb);
                    window.db = firebase.firestore();
                    initListeners();
                } else {
                    document.getElementById('status-display').innerText = "Firebase SDK Error";
                }
            } catch(e) { console.error(e); }

            // åŒ¯ç‡
            fetch('https://api.exchangerate-api.com/v4/latest/TWD').then(r=>r.json()).then(d=>{ if(d?.rates?.JPY) APP.rate = d.rates.JPY; renderHeader(); }).catch(()=>{});
            fetchWeather();
            
            // é è¨­è³‡æ–™
            APP.users = JSON.parse(JSON.stringify(CONFIG.users));
            APP.split.targets = APP.users.map(u=>u.id);
            render();
        };

        function initListeners() {
            const status = document.getElementById('status-display');
            const setOk = (ok) => { status.innerHTML = ok ? `<span class="text-emerald-400">â—</span> å·²é€£ç·š` : `<span class="text-red-400">â—</span> æ–·ç·š`; };

            db.collection("expenses").orderBy("timestamp","desc").onSnapshot(s => {
                let l=[]; s.forEach(d=>l.push({id:d.id,...d.data()})); APP.expenses=l;
                // åªæœ‰åœ¨éè¼¸å…¥ç‹€æ…‹æ‰é‡ç¹ªè¨˜å¸³é ï¼Œé¿å…è·³å‹•
                if(APP.tab==='accounting' && document.activeElement.tagName!=='INPUT') render();
                setOk(true);
            }, ()=>setOk(false));

            db.collection("itinerary").onSnapshot(s => {
                let l=[]; s.forEach(d=>l.push({id:d.id,...d.data()})); APP.itinerary=l;
                if(APP.tab==='itinerary') render();
            });

            db.collection("backup").orderBy("timestamp","desc").onSnapshot(s => {
                let l=[]; s.forEach(d=>l.push({id:d.id,...d.data()})); APP.backup=l;
                if(APP.tab==='backup') render();
            });

            db.collection("config").doc("users").onSnapshot(s => {
                if(s.exists) { APP.users = s.data().list; if(APP.split.targets.length===0) APP.split.targets=APP.users.map(u=>u.id); }
                else db.collection("config").doc("users").set({list:CONFIG.users});
                if(APP.tab==='accounting' || APP.tab==='split') render();
            });
        }

        async function fetchWeather() {
            try {
                const r = await fetch("https://api.open-meteo.com/v1/forecast?latitude=26.2124&longitude=127.6809&current=temperature_2m&timezone=Asia%2FTokyo");
                const d = await r.json();
                const el = document.getElementById('weather-display');
                if(d.current && el) {
                    el.innerHTML = `<i data-lucide="sun" width="12" class="text-yellow-400"></i> ${d.current.temperature_2m}Â°C`;
                    el.classList.remove('hidden'); el.classList.add('flex');
                    lucide.createIcons();
                }
            } catch(e){}
        }

        // --- å…¨åŸŸå‹•ä½œå‡½å¼ (Action Functions) ---
        function setTab(t) { APP.tab = t; render(); }
        function toggleTool() { document.getElementById('tool-panel').classList.toggle('hidden'); }
        function calc(t) {
            const j=document.getElementById('c-jpy'), tw=document.getElementById('c-twd');
            if(t==='jpy') tw.value = (j.value/APP.rate).toFixed(0);
            else j.value = (tw.value*APP.rate).toFixed(0);
        }
        function toggleEx(id) { APP.expandedId = APP.expandedId===id?null:id; render(); }
        
        // åˆ†å¸³è¼¸å…¥ (ä¸é‡ç¹ª)
        function inputSplit(v) { 
            APP.split.amt = v; 
            const d = document.getElementById('split-res');
            if(d) {
                const val = parseFloat(v);
                if(val && APP.split.targets.length>0) {
                    const per = Math.round(val/APP.split.targets.length);
                    const sym = APP.split.curr==='TWD'?'NT$':'Â¥';
                    d.innerHTML = `<div class="text-3xl text-amber-400 font-bold text-center mb-2">æ¯äºº ${sym}${per.toLocaleString()}</div><button onclick="saveSplit(${per})" class="w-full bg-amber-600 text-white py-2 rounded font-bold">å¯«å…¥è¨˜å¸³</button>`;
                } else d.innerHTML = `<div class="text-center text-slate-500 py-4">è¼¸å…¥é‡‘é¡...</div>`;
            }
        }
        function setSplitPayer(id) { APP.split.payer=id; if(!APP.split.targets.includes(id))APP.split.targets.push(id); render(); restoreSplit(); }
        function setSplitCurr(c) { APP.split.curr=c; render(); restoreSplit(); }
        function toggleSplitTarget(id) { 
            const i=APP.split.targets.indexOf(id); 
            if(i>-1) APP.split.targets.splice(i,1); else APP.split.targets.push(id); 
            render(); restoreSplit(); 
        }
        function restoreSplit() {
            const el = document.getElementById('sp-amt');
            if(el) { el.value = APP.split.amt; el.focus(); inputSplit(el.value); }
        }
        function saveSplit(per) {
            if(!confirm("å¯«å…¥?")) return;
            const s = APP.split;
            let val = parseFloat(s.amt);
            const names = APP.users.filter(u=>s.targets.includes(u.id)).map(u=>u.name).join(',');
            let note = `åˆ†å¸³: ç¸½${s.curr==='TWD'?'NT$':'Â¥'}${val} (${names})`;
            if(s.curr==='TWD') val = Math.round(val * APP.rate);
            
            db.collection("expenses").add({amount:val, cat:'food', note, userId:s.payer, timestamp:Date.now()});
            APP.split.amt=''; alert("å®Œæˆ"); render();
        }

        // è¨˜å¸³è¼¸å…¥ (ä¸é‡ç¹ª)
        function inputAmt(v) { APP.form.amt = v; }
        function inputNote(v) { APP.form.note = v; }
        function setFormUser(id) { APP.form.payer=id; render(); restoreForm(); }
        function setFormCurr(c) { APP.form.curr=c; render(); restoreForm(); }
        function setCat(c) { APP.form.cat=c; render(); restoreForm(); }
        function restoreForm() {
            const a = document.getElementById('acc-amt');
            const n = document.getElementById('acc-note');
            if(a) a.value = APP.form.amt;
            if(n) n.value = APP.form.note;
        }
        function submitExp() {
            const f = APP.form;
            if(!f.amt) { alert("é‡‘é¡?"); return; }
            let val = parseFloat(f.amt);
            if(f.curr==='TWD') val = Math.round(val * APP.rate);
            db.collection("expenses").add({amount:val, cat:f.cat, note:f.note, userId:f.payer, timestamp:Date.now()});
            APP.form.amt=''; APP.form.note=''; render();
        }
        function delExp(id) { if(confirm("åˆªé™¤?")) db.collection("expenses").doc(id).delete(); }
        function renameUser(id) {
            const u = APP.users.find(x=>x.id===id);
            const n = prompt("ä¿®æ”¹æš±ç¨±", u.name);
            if(n) { const l = APP.users.map(x=>x.id===id?{...x,name:n}:x); db.collection("config").doc("users").set({list:l}); }
        }

        // è¡Œç¨‹ & å‚™æ¡ˆ
        function uploadDefault() {
            if(!confirm("å¯«å…¥é è¨­?")) return;
            const b = db.batch();
            const def = [
                {day:0, time:"09:20", title:"æŠµé”é‚£éœ¸æ©Ÿå ´", note:"å–è»Š", cost:""}, {day:0, time:"11:30", title:"ç³»æ»¿é­šå¸‚å ´", note:"åˆé¤", cost:"2000"}, {day:0, time:"15:30", title:"ç¾åœ‹æ‘", note:"é€›è¡—", cost:""},
                {day:1, time:"08:00", title:"é’ä¹‹æ´çªŸ", note:"æµ®æ½›", cost:"4000"}, {day:1, time:"19:00", title:"ç‰çƒä¹‹ç‰›", note:"ç‡’è‚‰", cost:"8000"},
                {day:2, time:"11:00", title:"å¤å®‡åˆ©å³¶", note:"å¿ƒå½¢å²©", cost:""}, {day:2, time:"14:00", title:"ç¾éº—æµ·æ°´æ—é¤¨", note:"é»‘æ½®ä¹‹æµ·", cost:"2180"},
                {day:3, time:"11:00", title:"PARCO CITY", note:"è³¼ç‰©", cost:""}, {day:3, time:"20:00", title:"å”å‰è¨¶å¾·", note:"æƒè²¨", cost:""},
                {day:4, time:"09:30", title:"æ³¢ä¸Šå®®", note:"ç¥ç¤¾", cost:"800"}, {day:4, time:"22:00", title:"å‚‘å…‹ç‰›æ’", note:"å®µå¤œ", cost:"3000"},
                {day:5, time:"11:00", title:"Ashibinaa", note:"Outlet", cost:""}, {day:5, time:"19:40", title:"é‚£éœ¸æ©Ÿå ´", note:"è¿”å°", cost:""}
            ];
            def.forEach(e => { const r=db.collection("itinerary").doc(); b.set(r,{...e, timestamp:Date.now()}); });
            b.commit().then(()=>alert("å®Œæˆ"));
        }
        function addItin(day) {
            const t=prompt("æ™‚é–“(10:00)"); if(!t)return;
            const tt=prompt("æ¨™é¡Œ"); if(!tt)return;
            db.collection("itinerary").add({day,time:t,title:tt,note:prompt("å‚™è¨»")||'',cost:'',timestamp:Date.now()});
        }
        function delItin(id) { if(confirm("åˆªé™¤?")) db.collection("itinerary").doc(id).delete(); }
        function addBackup() { const t=prompt("åç¨±"); if(t) db.collection("backup").add({title:t,tag:'è‡ªè¨‚',note:'',timestamp:Date.now()}); }
        function delBackup(id) { if(confirm("åˆªé™¤?")) db.collection("backup").doc(id).delete(); }
        function addRec(t,g) { if(confirm("åŠ å…¥å‚™æ¡ˆ?")) db.collection("backup").add({title:t,tag:g,note:'æ¨è–¦',timestamp:Date.now()}); }
        function pushItin(id,t,n) {
            const d=prompt("ç¬¬å¹¾å¤©(1-6)?"); if(!d)return; const di=parseInt(d)-1;
            const tm=prompt("æ™‚é–“?"); if(di>=0&&di<=5) {
                db.collection("itinerary").add({day:di, time:tm||"10:00", title:t, note:n, cost:'', timestamp:Date.now()});
                if(confirm("ç§»é™¤å‚™æ¡ˆ?")) db.collection("backup").doc(id).delete();
            }
        }
        function doExport() {
            if(APP.expenses.length===0) return alert("ç„¡è³‡æ–™");
            let c = "\uFEFFæ—¥æœŸ,äºº,é …,æ—¥å¹£,å°å¹£,å‚™è¨»\n";
            APP.expenses.forEach(e => {
                const u = APP.users.find(x=>x.id===e.userId)?.name||'';
                const cat = CONFIG.cats.find(x=>x.id===e.cat)?.n||'';
                c += `${new Date(e.timestamp).toLocaleDateString()},${u},${cat},${e.amount},${Math.round(e.amount/APP.rate)},"${e.note||''}"\n`;
            });
            const l=document.createElement("a"); l.href=URL.createObjectURL(new Blob([c],{type:'text/csv'})); l.download="okinawa.csv"; l.click();
        }

        // --- Render ---
        function render() {
            renderHeader();
            renderNav();
            const c = document.getElementById('main-view');
            c.innerHTML = '';
            
            const t = APP.tab;
            if(t==='itinerary') renderItin(c);
            else if(t==='backup') renderBackup(c);
            else if(t==='recommend') renderRec(c);
            else if(t==='split') renderSplit(c);
            else renderAcc(c);
            lucide.createIcons();
        }

        function renderHeader() {
            const t = APP.tab;
            const tm = {'itinerary':'è¡Œç¨‹è¡¨','backup':'å‚™æ¡ˆ','recommend':'æ¨è–¦','split':'åˆ†å¸³','accounting':'è¨˜å¸³'};
            document.getElementById('app-title').innerHTML = `<i data-lucide="moon" class="text-yellow-400" width="20"></i> ${tm[t]}`;
            const btn = document.getElementById('btn-export');
            if(btn) btn.style.display = t==='accounting'?'block':'none';
        }

        function renderNav() {
            ['itinerary','backup','recommend','split','accounting'].forEach(t => {
                const el = document.getElementById('nav-'+t);
                el.className = `flex-1 flex flex-col items-center gap-1 p-2 text-xs transition-colors ${APP.tab===t ? 'text-indigo-400 font-bold' : 'text-slate-500'}`;
            });
        }

        function renderItin(c) {
            if(APP.itinerary.length===0) { c.innerHTML=`<div class="text-center py-10 text-slate-500"><button onclick="uploadDefault()" class="bg-indigo-600 text-white px-4 py-2 rounded">è¼‰å…¥é è¨­è¡Œç¨‹</button></div>`; return; }
            CONFIG.days.forEach((d,i) => {
                const evs = APP.itinerary.filter(e=>e.day===i).sort((a,b)=>a.time.localeCompare(b.time));
                let h = `<div class="bg-slate-800 rounded-lg overflow-hidden border border-slate-700 mb-4"><div class="bg-slate-900/50 p-3 flex justify-between items-center"><span class="font-bold text-slate-200">${d.d} ${d.t}</span><button onclick="addItin(${i})" class="text-indigo-400"><i data-lucide="plus-circle" width="18"></i></button></div>`;
                if(evs.length===0) h+=`<div class="p-3 text-center text-xs text-slate-500">ç„¡è¡Œç¨‹</div>`;
                else {
                    evs.forEach(e => {
                        const isEx = APP.expandedId === e.id;
                        const map = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent("æ²–ç¹© "+e.title)}`;
                        h += `<div onclick="toggleEx('${e.id}')" class="border-b border-slate-700/50 last:border-0 ${isEx?'bg-slate-700/30':''}"><div class="flex items-center p-3 gap-3 cursor-pointer"><div class="text-emerald-400 font-mono font-bold w-10 text-right text-sm">${e.time}</div><div class="flex-1 text-sm text-slate-200 font-bold">${e.title}</div></div>${isEx?`<div class="px-3 pb-3 pl-14 text-xs text-slate-400 animate-in fade-in"><div class="mb-2">${e.note||''}</div>${e.cost?`<div class="mb-2 text-emerald-400">Â¥${e.cost}</div>`:''}<div class="flex gap-2"><a href="${map}" target="_blank" class="bg-indigo-600 text-white px-2 py-1 rounded">å°èˆª</a><button onclick="delItin('${e.id}')" class="bg-red-900/30 text-red-300 px-2 py-1 rounded">åˆªé™¤</button></div></div>`:''}</div>`;
                    });
                }
                c.innerHTML += h + `</div>`;
            });
        }

        function renderBackup(c) {
            const list = APP.backup.length===0?`<div class="text-center text-slate-500 py-4">ç„¡å‚™æ¡ˆ</div>`:APP.backup.map(e=>`<div class="bg-slate-800 p-3 rounded-lg border border-slate-700 mb-2 flex gap-3"><div class="flex-1"><div class="font-bold text-slate-200 text-sm">${e.title}</div><div class="text-xs text-slate-500">${e.note||''}</div></div><div class="flex gap-2 items-center"><button onclick="pushToItin('${e.id}','${e.title}','${e.note}')" class="bg-indigo-600 text-white px-2 py-1 rounded text-xs">æ’ç¨‹</button><button onclick="delBackup('${e.id}')" class="text-red-400"><i data-lucide="trash-2" width="14"></i></button></div></div>`).join('');
            c.innerHTML = `<button onclick="addBackup()" class="w-full py-3 border border-dashed border-slate-600 text-slate-400 rounded-lg mb-4 hover:bg-slate-800">+ æ–°å¢å‚™æ¡ˆ</button>${list}`;
        }

        function renderRec(c) {
            const fDiv = `<div class="flex gap-2 overflow-x-auto pb-2 mb-2">${['å…¨éƒ¨','åŒ—éƒ¨','ä¸­éƒ¨','å—éƒ¨','ç¾é£Ÿ','è³¼ç‰©'].map(f=>`<button onclick="APP.recFilter='${f}';render()" class="px-3 py-1 rounded-full text-xs whitespace-nowrap ${APP.recFilter===f?'bg-blue-600 text-white':'bg-slate-800 text-slate-400'}">${f}</button>`).join('')}</div>`;
            const spots = APP.recFilter==='å…¨éƒ¨'?CONF.rec:CONF.rec.filter(s=>s.tag.includes(APP.recFilter));
            const list = spots.map(s=>`<div class="bg-slate-800 p-3 rounded-lg border border-slate-700 flex justify-between items-center"><div><div class="font-bold text-sm text-slate-200">${s.t}</div><div class="text-xs text-blue-400">${s.tag}</div></div><div class="flex gap-2"><a href="https://www.google.com/maps/search/?api=1&query=${encodeURIComponent('æ²–ç¹© '+s.t)}" target="_blank" class="bg-slate-700 text-slate-300 p-1.5 rounded"><i data-lucide="search" width="14"></i></a><button onclick="addBackupFromRec('${s.t}','${s.tag}')" class="bg-blue-600 text-white p-1.5 rounded"><i data-lucide="plus" width="14"></i></button></div></div>`).join('');
            c.innerHTML = fDiv + `<div class="grid grid-cols-2 gap-2">${list}</div>`;
        }

        function renderSplit(c) {
            const s=APP.split, isTwd=s.curr==='TWD', u=APP.users;
            c.innerHTML = `<div class="bg-slate-800 rounded-xl p-4 border border-slate-700"><div class="flex gap-2 mb-4"><input type="number" id="split-in" value="${s.amt}" oninput="inputSplit(this.value)" class="w-2/3 bg-slate-900 border-slate-600 rounded p-3 text-xl text-center text-white outline-none" placeholder="ç¸½é‡‘é¡"><div class="w-1/3 flex bg-slate-900 rounded border border-slate-600 p-1"><button onclick="setSplitCurr('JPY')" class="flex-1 rounded text-xs ${!isTwd?'bg-amber-600 text-white':'text-slate-400'}">JPY</button><button onclick="setSplitCurr('TWD')" class="flex-1 rounded text-xs ${isTwd?'bg-indigo-600 text-white':'text-slate-400'}">TWD</button></div></div><div class="space-y-3"><div><div class="text-xs text-slate-400 mb-1">ä»˜æ¬¾äºº</div><div class="flex gap-2 overflow-x-auto pb-1">${u.map(x=>`<button onclick="setSplitPayer('${x.id}')" class="px-3 py-2 rounded text-xs whitespace-nowrap transition-all ${s.payer===x.id?`${x.color} text-white`:'bg-slate-700 text-slate-400'}">${x.name}</button>`).join('')}</div></div><div><div class="text-xs text-slate-400 mb-1">åˆ†æ”¤å°è±¡</div><div class="grid grid-cols-2 gap-2">${u.map(x=>{const sel=s.targets.includes(x.id);return `<button onclick="togSplitTarget('${x.id}')" class="py-2 rounded text-xs border ${sel?'bg-slate-600 text-white border-amber-500':'bg-slate-700 text-slate-500 border-transparent'}">${x.name} ${sel?'âœ“':''}</button>`}).join('')}</div></div></div><div id="split-res" class="mt-4 pt-4 border-t border-slate-700/50"></div></div>`;
            inputSplit(s.amt);
        }

        function renderAcc(c) {
            const total = APP.expenses.reduce((a,b)=>a+b.amount,0);
            const totalT = Math.round(total/APP.rate);
            const uh = `<div class="grid grid-cols-4 gap-2 mb-4">${APP.users.map(u=>`<div onclick="renameUser('${u.id}')" class="flex flex-col items-center gap-1 cursor-pointer"><div class="w-10 h-10 rounded-full ${u.color} flex items-center justify-center text-white font-bold shadow">${u.name[0]}</div><span class="text-[10px] text-slate-400">${u.name}</span></div>`).join('')}</div>`;
            const isJpy = APP.form.curr==='JPY';
            const cats = CONF.cats.map(x=>`<button onclick="setFormCat('${x.id}')" class="flex flex-col items-center gap-1 p-1 rounded ${APP.form.cat===x.id?'bg-slate-700 ring-1 ring-emerald-500':''}"><i data-lucide="${x.i}" class="${x.c}" width="16"></i><span class="text-[9px] text-slate-400">${x.n}</span></button>`).join('');
            
            const fh = `<div class="bg-slate-800 rounded-xl p-4 border border-slate-700 shadow mb-6"><div class="flex gap-2 mb-3 justify-between bg-slate-900 p-1 rounded">${APP.users.map(u=>`<button onclick="setFormUser('${u.id}')" class="flex-1 py-1 text-xs rounded transition-colors ${APP.form.payer===u.id?`${u.color} text-white`:'text-slate-500'}">${u.name}</button>`).join('')}</div><div class="flex gap-2 mb-3"><input type="number" id="acc-amt" value="${APP.form.amt}" oninput="inputAmt(this.value)" placeholder="0" class="w-2/3 bg-slate-900 border-slate-600 rounded p-2 text-white text-lg outline-none focus:border-emerald-500"><div class="w-1/3 flex bg-slate-900 rounded border border-slate-600 p-1"><button onclick="setFormCurr('JPY')" class="flex-1 text-xs rounded ${isJpy?'bg-emerald-600 text-white':'text-slate-400'}">JPY</button><button onclick="setFormCurr('TWD')" class="flex-1 text-xs rounded ${!isJpy?'bg-indigo-600 text-white':'text-slate-400'}">TWD</button></div></div><div class="grid grid-cols-6 gap-1 mb-3">${cats}</div><div class="flex gap-2"><input id="acc-note" value="${APP.form.note}" oninput="inputNote(this.value)" placeholder="å‚™è¨»..." class="flex-1 bg-slate-900 border-slate-600 rounded px-3 text-sm text-white outline-none"><button onclick="submitExp()" class="bg-emerald-600 text-white p-2 rounded shadow"><i data-lucide="plus" width="20"></i></button></div></div>`;
            const lst = `<div class="space-y-2">${APP.expenses.length===0?'<div class="text-center text-xs text-slate-500 py-4">ç„¡ç´€éŒ„</div>':APP.expenses.map(e=>{
                const u=APP.users.find(x=>x.id===e.userId)||CONF.users[0]; const cat=CONF.cats.find(x=>x.id===e.cat)||CONF.cats[0];
                return `<div class="bg-slate-800 border-l-4 ${u.border} rounded mb-2 p-3 flex items-center gap-3 relative group"><div class="flex-1"><div class="flex justify-between"><span class="text-sm font-bold text-slate-200">${e.note||cat.n}</span><span class="font-mono text-white">Â¥${e.amount}</span></div><div class="text-[10px] text-slate-500 flex justify-between mt-1"><span>${u.name}</span><span>â‰ˆ NT$${Math.round(e.amount/APP.rate)}</span></div></div><button onclick="delExp('${e.id}')" class="text-red-400 opacity-50 hover:opacity-100"><i data-lucide="trash-2" width="14"></i></button></div>`;
            }).join('')}</div>`;

            c.innerHTML = `<div class="bg-slate-800 p-4 rounded-xl border border-slate-700 mb-4 flex justify-between items-center"><div><div class="text-2xl font-bold text-white">Â¥${total.toLocaleString()}</div><div class="text-xs text-slate-400">ç¸½è¨ˆç´„ NT$${totalT.toLocaleString()}</div></div><div class="flex gap-1">${APP.users.map(u=>`<div onclick="renameUser('${u.id}')" class="w-6 h-6 rounded-full ${u.color} flex items-center justify-center text-[10px] text-white font-bold cursor-pointer">${u.name[0]}</div>`).join('')}</div></div>${fh}${lst}`;
            
            const ai = document.getElementById('acc-amt'), an = document.getElementById('acc-note');
            if(ai && document.activeElement!==ai && APP.form.amt) ai.focus();
            if(an && document.activeElement!==an && APP.form.note) an.focus();
        }
    </script>
</body>
</html>


