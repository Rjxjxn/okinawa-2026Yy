<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>2026 æ²–ç¹©æ—…éŠå°ç§˜æ›¸ (V29)</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Firebase Compat SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

    <style>
        .pb-safe { padding-bottom: env(safe-area-inset-bottom); }
        body { background-color: #0f172a; color: #f1f5f9; font-family: sans-serif; touch-action: manipulation; }
        ::-webkit-scrollbar { width: 4px; height: 4px; }
        ::-webkit-scrollbar-track { background: #0f172a; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 4px; }
        .fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        #loading-screen { position: fixed; inset: 0; background: #0f172a; z-index: 9999; display: flex; justify-content: center; align-items: center; flex-direction: column; transition: opacity 0.5s; }
    </style>
</head>
<body class="pb-24">

    <!-- Loading -->
    <div id="loading-screen">
        <div class="animate-spin text-emerald-500 mb-4"><i data-lucide="loader-2" width="48" height="48"></i></div>
        <div class="text-slate-400 text-sm">è¼‰å…¥ä¸­...</div>
    </div>

    <!-- Header -->
    <div class="bg-[#1e293b]/95 backdrop-blur-md shadow-lg sticky top-0 z-30 border-b border-indigo-500/30">
        <div class="max-w-3xl mx-auto px-4 py-3">
            <div class="flex justify-between items-center mb-2">
                <div>
                    <h1 id="app-title" class="text-lg md:text-2xl font-bold flex items-center gap-2 text-white">
                        <i data-lucide="moon" class="text-yellow-300" width="20"></i> 2026 æ²–ç¹©è¡Œ
                    </h1>
                    <div class="flex items-center gap-3 mt-1">
                        <span id="weather-widget" class="text-[10px] flex items-center gap-1 text-slate-300 bg-slate-800/80 px-2 py-0.5 rounded-full border border-slate-600 hidden"></span>
                        <span id="cloud-status" class="text-[10px] flex items-center gap-1 transition-colors text-slate-500">
                            <div class="w-2 h-2 rounded-full bg-slate-500"></div> é€£ç·šä¸­...
                        </span>
                        <p id="app-subtitle" class="text-[10px] md:text-xs text-slate-400 font-medium tracking-wide hidden"></p>
                    </div>
                </div>
                <div class="flex gap-2">
                    <button id="btn-export" onclick="exportCSV()" class="hidden p-2 rounded-full bg-emerald-600 text-white hover:bg-emerald-500 transition-all shadow-lg"><i data-lucide="download" width="18"></i></button>
                    <button onclick="toggleConverter()" class="p-2 rounded-full bg-slate-800 text-slate-400 hover:bg-slate-700 transition-all"><i data-lucide="calculator" width="18"></i></button>
                </div>
            </div>
            <div id="converter-panel" class="hidden bg-slate-800/80 rounded-lg p-3 border border-slate-600 mt-2 fade-in">
                <div class="flex items-center gap-2">
                    <div class="relative flex-1"><span class="absolute left-2 top-2 text-xs text-slate-400">ğŸ‡¯ğŸ‡µ JPY</span><input type="number" id="conv-jpy" oninput="convertCurrency('jpy')" class="w-full bg-slate-900 border border-slate-600 rounded p-1.5 pt-6 text-white text-right focus:outline-none focus:border-indigo-500"></div>
                    <i data-lucide="arrow-right-left" class="text-slate-500" width="16"></i>
                    <div class="relative flex-1"><span class="absolute left-2 top-2 text-xs text-slate-400">ğŸ‡¹ğŸ‡¼ TWD</span><input type="number" id="conv-twd" oninput="convertCurrency('twd')" class="w-full bg-slate-900 border border-slate-600 rounded p-1.5 pt-6 text-white text-right focus:outline-none focus:border-emerald-500"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Content -->
    <div id="main-content" class="max-w-3xl mx-auto px-3 py-4 space-y-5 fade-in"></div>

    <!-- Footer -->
    <div class="fixed bottom-0 left-0 right-0 bg-[#1e293b]/95 backdrop-blur-md border-t border-slate-700 pb-safe z-40">
        <div class="flex justify-around max-w-3xl mx-auto">
            <button onclick="switchTab('itinerary')" id="tab-itinerary" class="flex-1 py-4 flex flex-col items-center gap-1 text-[10px] font-medium transition-colors text-indigo-400"><i data-lucide="calendar" width="24"></i> è¡Œç¨‹</button>
            <div class="w-px bg-slate-700 my-3 opacity-50"></div>
            <button onclick="switchTab('backup')" id="tab-backup" class="flex-1 py-4 flex flex-col items-center gap-1 text-[10px] font-medium transition-colors text-slate-500"><i data-lucide="folder-plus" width="24"></i> å‚™æ¡ˆ</button>
            <div class="w-px bg-slate-700 my-3 opacity-50"></div>
            <button onclick="switchTab('recommend')" id="tab-recommend" class="flex-1 py-4 flex flex-col items-center gap-1 text-[10px] font-medium transition-colors text-slate-500"><i data-lucide="thumbs-up" width="24"></i> æ¨è–¦</button>
            <div class="w-px bg-slate-700 my-3 opacity-50"></div>
            <button onclick="switchTab('split')" id="tab-split" class="flex-1 py-4 flex flex-col items-center gap-1 text-[10px] font-medium transition-colors text-slate-500"><i data-lucide="divide-square" width="24"></i> åˆ†å¸³</button>
            <div class="w-px bg-slate-700 my-3 opacity-50"></div>
            <button onclick="switchTab('accounting')" id="tab-accounting" class="flex-1 py-4 flex flex-col items-center gap-1 text-[10px] font-medium transition-colors text-slate-500"><i data-lucide="wifi" width="24"></i> è¨˜å¸³</button>
        </div>
    </div>

    <script>
        // ==========================================
        // å…¨åŸŸè®Šæ•¸
        // ==========================================
        window.state = {
            activeTab: 'itinerary',
            itineraryEvents: [],
            backupEvents: [],
            expenses: [],
            users: [],
            rate: 4.65,
            expandedId: null,
            expandedExpenseId: null,
            selectedUser: 'u1',
            isAddingItinerary: null,
            isAddingBackup: false,
            recommendFilter: 'å…¨éƒ¨',
            formAmount: '',
            formNote: '',
            splitAmount: '',
            splitPayer: 'u1',
            splitTargets: [],
            splitCurrency: 'JPY'
        };

        window.tempExpCat = 'food';
        window.tempExpCurr = 'JPY';

        const firebaseConfig = {
          apiKey: "AIzaSyBvclnyKUkCUzyBnGljSMsg38DfgroRDxg",
          authDomain: "okinawaonline-64b20.firebaseapp.com",
          projectId: "okinawaonline-64b20",
          storageBucket: "okinawaonline-64b20.firebasestorage.app",
          messagingSenderId: "457339726484",
          appId: "1:457339726484:web:686abfc9820d6d9c4b2281",
          measurementId: "G-7XV7V6QXBV"
        };

        // ==========================================
        // Init
        // ==========================================
        window.onload = function() {
            setTimeout(() => { const l = document.getElementById('loading-screen'); if(l) { l.style.opacity='0'; setTimeout(()=>l.style.display='none',500); }}, 1500);
            
            try {
                if(typeof firebase !== 'undefined') {
                    firebase.initializeApp(firebaseConfig);
                    window.db = firebase.firestore();
                    window.usersRef = db.collection("config").doc("users");
                    window.expensesRef = db.collection("expenses");
                    window.itineraryRef = db.collection("itinerary_events");
                    window.backupRef = db.collection("backup_events");
                    initListeners();
                }
            } catch (e) { console.error(e); }

            fetch('https://api.exchangerate-api.com/v4/latest/TWD').then(r=>r.json()).then(d=>{if(d?.rates?.JPY) window.state.rate=d.rates.JPY; renderHeader();}).catch(()=>{});
            fetchWeather();
            updateCountdown();
            renderAll();
        };

        function initListeners() {
            const updateStatus = (ok) => {
                const el = document.getElementById('cloud-status');
                if(el) {
                    el.innerHTML = ok ? `<div class="w-2 h-2 rounded-full bg-emerald-500 animate-pulse"></div> é›²ç«¯å·²é€£ç·š` : `<div class="w-2 h-2 rounded-full bg-red-500"></div> é€£ç·šä¸­æ–·`;
                    el.className = ok ? "text-[10px] flex items-center gap-1 transition-colors text-emerald-500" : "text-[10px] flex items-center gap-1 text-red-500";
                }
            };
            expensesRef.orderBy("timestamp", "desc").onSnapshot(s => { let l=[]; s.forEach(d=>l.push({id:d.id,...d.data()})); window.state.expenses=l; if(window.state.activeTab==='accounting') renderContent(true); updateStatus(true); }, ()=>updateStatus(false));
            itineraryRef.onSnapshot(s => { let l=[]; s.forEach(d=>l.push({id:d.id,...d.data()})); window.state.itineraryEvents=l; if(window.state.activeTab==='itinerary') renderContent(); });
            backupRef.orderBy("timestamp", "desc").onSnapshot(s => { let l=[]; s.forEach(d=>l.push({id:d.id,...d.data()})); window.state.backupEvents=l; if(window.state.activeTab==='backup') renderContent(); });
            usersRef.onSnapshot(s => { 
                if(s.exists) {
                    window.state.users=s.data().list;
                    if(window.state.splitTargets.length === 0) window.state.splitTargets = window.state.users.map(u => u.id);
                } else usersRef.set({list:DEFAULT_USERS}); 
                if(window.state.activeTab==='accounting' || window.state.activeTab==='split') renderContent(true); 
            });
        }

        async function fetchWeather() {
            try { const r=await fetch("https://api.open-meteo.com/v1/forecast?latitude=26.2124&longitude=127.6809&current=temperature_2m,weather_code&timezone=Asia%2FTokyo"); const d=await r.json(); if(d.current){const el=document.getElementById('weather-widget'); if(el){el.innerHTML=`<i data-lucide="sun" width="14" class="text-yellow-400"></i> é‚£éœ¸ ${d.current.temperature_2m}Â°C`; el.classList.remove('hidden'); lucide.createIcons();}}}catch(e){}
        }

        function updateCountdown() {
            const target = new Date("2026-05-25");
            const now = new Date();
            const diff = Math.ceil((target - now) / (1000 * 60 * 60 * 24));
            const el = document.getElementById('app-subtitle');
            if(el) {
                if(diff > 0) el.innerHTML = `è·é›¢å‡ºç™¼é‚„æœ‰ ${diff} å¤©`;
                else if(diff === 0) el.innerHTML = `å°±æ˜¯ä»Šå¤©! å‡ºç™¼!`;
                else el.innerHTML = `æ—…ç¨‹çµæŸ`;
                el.classList.remove('hidden');
            }
        }

        // ==========================================
        // UI Rendering
        // ==========================================
        window.switchTab = function(t) { window.state.activeTab=t; renderAll(); }
        window.toggleExpand = function(id) { window.state.expandedId=window.state.expandedId===id?null:id; renderContent(); }
        window.toggleExpandExpense = function(id) { window.state.expandedExpenseId=window.state.expandedExpenseId===id?null:id; renderContent();lucide.createIcons(); }
        window.selectUser = function(id) { window.state.selectedUser=id; renderContent(); }
        window.setRecommendFilter = function(f) { window.state.recommendFilter=f; renderContent(); }
        window.setExpCurr = function(c) { window.tempExpCurr=c; renderContent(); }
        window.setExpCat = function(c) { window.tempExpCat=c; renderContent(); }
        window.syncAmount = function(v) { window.state.formAmount = v; }
        window.syncNote = function(v) { window.state.formNote = v; }

        // Split UI Handlers
        window.updateSplitCalc = function(val) {
            window.state.splitAmount = val;
            const resultDiv = document.getElementById('split-result-area');
            const amount = parseFloat(val);
            const targets = window.state.splitTargets;
            const payerId = window.state.splitPayer;
            const users = window.state.users;
            const payer = users.find(u => u.id === payerId);
            
            if (amount && targets.length > 0) {
                const perPerson = Math.round(amount / targets.length);
                const curr = window.state.splitCurrency;
                const symbol = curr === 'TWD' ? 'NT$' : 'Â¥';
                const debtors = targets.filter(uid => uid !== payerId);
                
                let detailHtml = '';
                if(debtors.length === 0) {
                     detailHtml = `<div class="text-xs text-slate-300 mb-2">å®Œå…¨ç”± ${payer.name} è‡ªå·±è² æ“”</div>`;
                } else {
                     detailHtml = debtors.map(uid => {
                        const u = users.find(x => x.id === uid);
                        return `<div class="flex justify-between text-xs text-slate-300 border-b border-amber-700/30 pb-1 mb-1"><span>${u.name} çµ¦ ${payer.name}</span><span class="font-bold text-amber-200">${symbol}${perPerson.toLocaleString()}</span></div>`;
                     }).join('');
                }

                resultDiv.innerHTML = `
                    <div class="bg-amber-900/40 border border-amber-600/50 rounded-xl p-4 mt-4 animate-in fade-in">
                        <div class="text-center mb-1 text-amber-200 text-xs">ç¸½é‡‘é¡ ${symbol}${amount.toLocaleString()} / ${targets.length}äºº</div>
                        <div class="text-center text-2xl font-bold text-white mb-3">æ¯äººåˆ†æ“” ${symbol}${perPerson.toLocaleString()}</div>
                        <div class="bg-black/20 rounded p-2 mb-3 space-y-1">${detailHtml}</div>
                        <button onclick="window.submitSplitToAccounting(${perPerson})" class="w-full bg-amber-600 hover:bg-amber-500 text-white py-3 rounded-lg font-bold shadow-lg flex items-center justify-center gap-2 transition-transform active:scale-95">
                            <i data-lucide="save" width="18"></i> å¯«å…¥è¨˜å¸³
                        </button>
                    </div>
                `;
                lucide.createIcons();
            } else {
                resultDiv.innerHTML = `<div class="text-center text-slate-500 text-sm py-4">è¼¸å…¥é‡‘é¡ä¸¦é¸æ“‡åˆ†å¸³å°è±¡...</div>`;
            }
        }
        
        window.setSplitPayer = function(id) { 
            window.state.splitPayer = id; 
            if(!window.state.splitTargets.includes(id)) window.state.splitTargets.push(id);
            renderContent(); 
            const inputEl = document.getElementById('split-amount-input');
            if(inputEl) { const val = inputEl.value; inputEl.value = ''; inputEl.value = val; inputEl.focus(); window.updateSplitCalc(val); }
        }
        window.toggleSplitTarget = function(id) {
            const idx = window.state.splitTargets.indexOf(id);
            if(idx > -1) window.state.splitTargets.splice(idx, 1);
            else window.state.splitTargets.push(id);
            renderContent();
            const inputEl = document.getElementById('split-amount-input');
            if(inputEl) { const val = inputEl.value; inputEl.value = ''; inputEl.value = val; inputEl.focus(); window.updateSplitCalc(val); }
        }

        window.setSplitCurrency = function(curr) {
            window.state.splitCurrency = curr;
            renderContent();
            const inputEl = document.getElementById('split-amount-input');
            if(inputEl) { const val = inputEl.value; inputEl.value = ''; inputEl.value = val; inputEl.focus(); window.updateSplitCalc(val); }
        }

        window.submitSplitToAccounting = function(perPerson) {
            if(confirm(`ç¢ºå®šå¯«å…¥è¨˜å¸³ï¼Ÿ`)) {
                const payer = window.state.users.find(u => u.id === window.state.splitPayer);
                const targetNames = window.state.users.filter(u => window.state.splitTargets.includes(u.id)).map(u => u.name).join(', ');
                let finalAmount = parseFloat(window.state.splitAmount);
                const curr = window.state.splitCurrency;
                const perPersonStr = curr === 'TWD' ? `NT$${perPerson}` : `Â¥${perPerson}`;
                let noteText = `åˆ†å¸³: ç¸½é¡${curr==='TWD'?'NT$':'Â¥'}${finalAmount} (æ¯äºº${perPersonStr})`;
                if (curr === 'TWD') {
                    finalAmount = Math.round(finalAmount * window.state.rate);
                }
                window.addCloudExpense({
                    amount: finalAmount,
                    cat: 'food', 
                    note: noteText,
                    userId: window.state.splitPayer
                });
                window.state.splitAmount = '';
                alert("å·²å¯«å…¥è¨˜å¸³é é¢ï¼");
                renderContent();
            }
        }

        window.exportCSV = function() {
            if(window.state.expenses.length === 0) { alert("æ²’æœ‰è¨˜å¸³è³‡æ–™å¯åŒ¯å‡º"); return; }
            let csvContent = "\uFEFF";
            csvContent += "æ—¥æœŸ,ä»˜æ¬¾äºº,é¡åˆ¥,é‡‘é¡(JPY),å°å¹£ç´„(TWD),å‚™è¨»\n";
            window.state.expenses.forEach(e => {
                const date = new Date(e.timestamp).toLocaleDateString();
                const user = window.state.users.find(u => u.id === e.userId)?.name || 'Unknown';
                const cat = EXPENSE_CATEGORIES.find(c => c.id === e.cat)?.name || 'å…¶ä»–';
                const twd = Math.round(e.amount / window.state.rate);
                const note = e.note ? `"${e.note.replace(/"/g, '""')}"` : "";
                csvContent += `${date},${user},${cat},${e.amount},${twd},${note}\n`;
            });
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            const url = URL.createObjectURL(blob);
            link.setAttribute("href", url);
            link.setAttribute("download", "æ²–ç¹©è¨˜å¸³_2026.csv");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function renderAll() { renderHeader(); renderContent(); renderBottomNav(); lucide.createIcons(); }
        
        function renderHeader() {
            let t='', s='';
            const tab = window.state.activeTab;
            const elT = document.getElementById('app-title');
            const elS = document.getElementById('app-subtitle');
            const exportBtn = document.getElementById('btn-export');
            
            if(exportBtn) exportBtn.classList.toggle('hidden', tab !== 'accounting');

            if(tab === 'itinerary'){ t=`<i data-lucide="moon" class="text-yellow-300"></i> <span class="text-indigo-400">2026 æ²–ç¹©è¡Œ</span>`; s='Day 1 - Day 6 â€¢ å¤œè²“è¡Œç¨‹'; }
            else if(tab === 'backup'){ t=`<i data-lucide="folder-plus" class="text-pink-400"></i> <span class="text-pink-400">é å‚™è¡Œç¨‹</span>`; s='é›¨å¤©å‚™æ¡ˆ & å£è¢‹åå–®'; }
            else if(tab === 'recommend'){ t=`<i data-lucide="thumbs-up" class="text-blue-400"></i> <span class="text-blue-400">50é¸æ¨è–¦</span>`; s='é»æ“ŠåŠ å…¥å‚™æ¡ˆ â€¢ Google æœå°‹'; }
            else if(tab === 'split'){ t=`<i data-lucide="divide-square" class="text-amber-400"></i> <span class="text-amber-400">æ™ºæ…§åˆ†å¸³</span>`; s='å¿«é€Ÿè¨ˆç®— â€¢ ä¸€éµè¨˜å¸³'; }
            else { t=`<i data-lucide="wifi" class="text-emerald-400"></i> <span class="text-emerald-400">é›²ç«¯è¨˜å¸³</span>`; s=`åŒ¯ç‡: 1 TWD â‰ˆ ${window.state.rate.toFixed(2)} JPY`; }
            
            if(elT) elT.innerHTML = t;
            if(elS) { elS.innerText = s; elS.classList.remove('hidden'); }
        }

        function renderBottomNav() {
            const tabs=['itinerary','backup','recommend','split','accounting'];
            const colors={itinerary:'text-indigo-400',backup:'text-pink-400',recommend:'text-blue-400',split:'text-amber-400',accounting:'text-emerald-400'};
            tabs.forEach(t => {
                const b = document.getElementById(`nav-${t}`);
                if(b) b.className = `flex-1 py-3 flex flex-col items-center gap-1 text-[10px] font-medium transition-colors ${window.state.activeTab===t ? colors[t] : 'text-slate-500'}`;
            });
        }

        function renderContent(skipInputCheck=false) {
            const c = document.getElementById('main-view');
            if(!c) return;
            if(!skipInputCheck && (window.state.activeTab==='accounting'||window.state.activeTab==='split')) { if(document.activeElement && document.activeElement.tagName === 'INPUT') return; }
            c.innerHTML = '';
            const t = window.state.activeTab;
            if(t === 'itinerary') renderItinerary(c);
            else if(t === 'backup') renderBackup(c);
            else if(t === 'recommend') renderRecommend(c);
            else if(t === 'split') renderSplit(c);
            else renderAccounting(c);
            if(window.lucide) lucide.createIcons();
        }

        // --- Helpers ---
        function getSafeMapLink(input) {
            if (!input) return '#';
            let query = input;
            if (input.startsWith('http')) {
                try {
                    const url = new URL(input);
                    const q = url.searchParams.get('q') || url.searchParams.get('query');
                    if(q) query = q;
                    else if(url.pathname.includes('/search/')) query = decodeURIComponent(url.pathname.split('/search/')[1]);
                } catch(e){}
            } else {
                if (!query.includes('æ²–ç¹©') && !query.includes('Okinawa')) query = 'æ²–ç¹© ' + query;
            }
            return `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(query)}`;
        }

        function getImageUrl(key) {
            const map={'airport':'https://images.unsplash.com/photo-1570303057398-75c1a477383a?auto=format&fit=crop&w=800&q=80','american-village':'https://plus.unsplash.com/premium_photo-1661962360706-5f72782cc68f?auto=format&fit=crop&w=800&q=80','snorkeling':'https://images.unsplash.com/photo-1544551763-46a013bb70d5?auto=format&fit=crop&w=800&q=80','beef':'https://images.unsplash.com/photo-1558030006-450675393462?auto=format&fit=crop&w=800&q=80','default':'https://images.unsplash.com/photo-1542051841857-5f90071e7989?auto=format&fit=crop&w=800&q=80','bridge':'https://images.unsplash.com/photo-1621846830364-79354964e54c?auto=format&fit=crop&w=800&q=80','okinawa-sea':'https://images.unsplash.com/photo-1590523741831-ab7f291db9f1?auto=format&fit=crop&w=800&q=80','coffee':'https://images.unsplash.com/photo-1510414842594-a61c69b5ae57?auto=format&fit=crop&w=800&q=80','shopping-bag':'https://images.unsplash.com/photo-1519567241046-7f570eee3ce6?auto=format&fit=crop&w=800&q=80','night-view':'https://images.unsplash.com/photo-1517457373958-b7bdd4587205?auto=format&fit=crop&w=800&q=80','senaga':'https://images.unsplash.com/photo-1510414842594-a61c69b5ae57?auto=format&fit=crop&w=800&q=80','food-taco':'https://images.unsplash.com/photo-1565299585323-38d6b0865b47?auto=format&fit=crop&w=800&q=80','donki':'https://images.unsplash.com/photo-1607082349566-187342175e2f?auto=format&fit=crop&w=800&q=80','supermarket':'https://images.unsplash.com/photo-1542838132-92c53300491e?auto=format&fit=crop&w=800&q=80','shrine':'https://images.unsplash.com/photo-1624867439366-4d058e578c7c?auto=format&fit=crop&w=800&q=80','market':'https://images.unsplash.com/photo-1533920145328-86e5d5a2da15?auto=format&fit=crop&w=800&q=80','parco':'https://images.unsplash.com/photo-1519567241046-7f570eee3ce6?auto=format&fit=crop&w=800&q=80','aquarium':'https://images.unsplash.com/photo-1535591273668-578e31182c4f?auto=format&fit=crop&w=800&q=80','outlet':'https://images.unsplash.com/photo-1441986300917-64674bd600d8?auto=format&fit=crop&w=800&q=80','kokusai':'https://images.unsplash.com/photo-1582656914563-7188b8e0b62e?auto=format&fit=crop&w=800&q=80','beer':'https://images.unsplash.com/photo-1575425186775-b8de9a427e67?auto=format&fit=crop&w=800&q=80','pizza':'https://images.unsplash.com/photo-1574071318508-1cdbab80d002?auto=format&fit=crop&w=800&q=80'}; return m[k]||m['default'];}

        // --- Config Data ---
        const EXPENSE_CATEGORIES = [
            { id: 'food', name: 'é¤é£²', icon: 'utensils', color: 'bg-orange-500' },
            { id: 'transport', name: 'äº¤é€š', icon: 'bus', color: 'bg-blue-500' },
            { id: 'shopping', name: 'è³¼ç‰©', icon: 'shopping-bag', color: 'bg-pink-500' },
            { id: 'ticket', name: 'é–€ç¥¨', icon: 'ticket', color: 'bg-purple-500' },
            { id: 'hotel', name: 'ä½å®¿', icon: 'home', color: 'bg-indigo-500' },
            { id: 'other', name: 'å…¶ä»–', icon: 'more-horizontal', color: 'bg-gray-500' },
        ];
        const DAYS_STRUCTURE=[{date:"Day 1 (5/25 ä¸€)",title:"è™èˆªæ—©ç­æ©Ÿ & ç¾åœ‹æ‘",icon:"plane"},{date:"Day 2 (5/26 äºŒ)",title:"è—æ´æµ®æ½› & é ‚ç´šç‡’è‚‰",icon:"sun"},{date:"Day 3 (5/27 ä¸‰)",title:"åŒ—éƒ¨é¢¨å…‰ & å±…é…’å±‹",icon:"map-pin"},{date:"Day 4 (5/28 å››)",title:"è³¼ç‰©æ—¥ & å”å‰è¨¶å¾·",icon:"shopping-bag"},{date:"Day 5 (5/29 äº”)",title:"å—éƒ¨æ‚ é–’ & ç‰›æ’å®µå¤œ",icon:"coffee"},{date:"Day 6 (5/30 å…­)",title:"Outlet & æ©Ÿå ´å…ç¨…",icon:"plane"}];
        const DEFAULT_USERS = [
            { id: 'u1', name: 'æ—…å®¢ A', color: 'bg-blue-500', text: 'text-blue-400', border: 'border-blue-500' },
            { id: 'u2', name: 'æ—…å®¢ B', color: 'bg-pink-500', text: 'text-pink-400', border: 'border-pink-500' },
            { id: 'u3', name: 'æ—…å®¢ C', color: 'bg-amber-500', text: 'text-amber-400', border: 'border-amber-500' },
            { id: 'u4', name: 'æ—…å®¢ D', color: 'bg-emerald-500', text: 'text-emerald-400', border: 'border-emerald-500' },
        ];
        
        // å®Œæ•´ 50+ æ™¯é»
        const RECOMMENDED_SPOTS = [
            { title: "ç¾éº—æµ·æ°´æ—é¤¨", tag: "åŒ—éƒ¨", note: "å¿…çœ‹é»‘æ½®ä¹‹æµ·é¯¨é¯Š", img: "aquarium" }, { title: "å¤å®‡åˆ©å³¶", tag: "åŒ—éƒ¨", note: "é–‹è»Šå°±èƒ½åˆ°çš„é›¢å³¶ï¼Œæœ‰å¿ƒå½¢å²©", img: "bridge" }, { title: "å‚™ç€¨ç¦æœ¨æ—é“", tag: "åŒ—éƒ¨", note: "é¨è…³è¸è»Šç©¿æ¢­ç¶ è‰²éš§é“ï¼Œç›¡é ­æ˜¯æµ·", img: "okinawa-sea" }, { title: "å²¸æœ¬é£Ÿå ‚", tag: "åŒ—éƒ¨", note: "ç™¾å¹´è€åº—ï¼Œæ‰‹æ‰“æ²–ç¹©éºµ", img: "food-taco" }, { title: "å¤å®‡åˆ©æµ·æ´‹å¡”", tag: "åŒ—éƒ¨", note: "æ­è‡ªå‹•é§•é§›è»Šä¸Šå»çœ‹æµ·æ™¯", img: "bridge" },
            { title: "ä»Šæ­¸ä»åŸè·¡", tag: "åŒ—éƒ¨", note: "ä¸–ç•Œéºç”¢ï¼Œè³æ«»åæ‰€", img: "shrine" }, { title: "åè­·é³³æ¢¨åœ’", tag: "åŒ—éƒ¨", note: "æ­ä¹˜å¯æ„›é³³æ¢¨è™ŸéŠåœ’è»Šï¼Œè¦ªå­å¿…å»", img: "american-village" }, { title: "Neo Park æ²–ç¹©", tag: "åŒ—éƒ¨", note: "é³¥é¡å‹•ç‰©åœ’ï¼Œå¯è¿‘è·é›¢æ¥è§¸", img: "snorkeling" }, { title: "Orion å•¤é…’å·¥å» ", tag: "åŒ—éƒ¨", note: "åƒè§€å…è²»é‚„é€å…©æ¯å•¤é…’(éœ€é ç´„)", img: "beer" }, { title: "èŠ±äººé€¢", tag: "åŒ—éƒ¨", note: "è€å®…æµ·æ™¯Pizzaï¼Œæ’éšŠååº—", img: "pizza" },
            { title: "éƒ¨ç€¨åæµ·ä¸­å…¬åœ’", tag: "åŒ—éƒ¨", note: "æµ·ä¸­å±•æœ›å¡”ï¼Œä¸ç”¨æ¿•èº«çœ‹ç†±å¸¶é­š", img: "okinawa-sea" }, { title: "å…«é‡å²³æ«»ä¹‹æ£®", tag: "åŒ—éƒ¨", note: "æ—¥æœ¬æœ€æ—©é–‹çš„æ«»èŠ±(1-2æœˆ)", img: "shrine" }, { title: "é‚Šæˆ¶å²¬", tag: "åŒ—éƒ¨", note: "æ²–ç¹©æœ€åŒ—ç«¯çµ•æ™¯", img: "okinawa-sea" }, { title: "å¤§å®¶ (Ufuya)", tag: "åŒ—éƒ¨", note: "ç™¾å¹´å¤å®¶åƒé˜¿å¤è±¬", img: "food-taco" },
            { title: "ç¾åœ‹æ‘", tag: "ä¸­éƒ¨", note: "ç¾å¼é¢¨æƒ…ï¼Œæ—¥è½ã€é€›è¡—ã€æ‘©å¤©è¼ª", img: "american-village" }, { title: "è¬åº§æ¯›", tag: "ä¸­éƒ¨", note: "åƒå¤§è±¡é¼»å­çš„çŠç‘šç¤æ‡¸å´–", img: "okinawa-sea" }, { title: "æ®˜æ³¢å²¬ç‡ˆå¡”", tag: "ä¸­éƒ¨", note: "æ–·å´–çµ•å£èˆ‡ç™½è‰²ç‡ˆå¡”ï¼Œå¤•é™½è¶…ç¾", img: "okinawa-sea" }, { title: "æ¸¯å·å¤–äººä½å®…", tag: "ä¸­éƒ¨", note: "ç¾å¼è€å±‹æ”¹é€ çš„æ–‡é’èšè½ï¼Œå¥½æ‹ç…§", img: "coffee" }, { title: "æ°¸æ—ºå¤¢æ¨‚åŸ", tag: "ä¸­éƒ¨", note: "æ²–ç¹©æœ€å¤§è³¼ç‰©ä¸­å¿ƒï¼Œæœ‰è¶…å¤§æ°´æ—ç®±", img: "shopping-bag" },
            { title: "æ±å—æ¤ç‰©æ¨‚åœ’", tag: "ä¸­éƒ¨", note: "äºç†±å¸¶æ¤ç‰©èˆ‡è¶…ç¾å¤œé–“é»ç‡ˆ", img: "night-view" }, { title: "ç‰çƒæ‘", tag: "ä¸­éƒ¨", note: "é«”é©—å‚³çµ±ç‰çƒæ–‡åŒ–èˆ‡å·¥è—", img: "shrine" }, { title: "åº§å–œå‘³åŸè·¡", tag: "ä¸­éƒ¨", note: "å…è²»å…¥å ´çš„ä¸–ç•Œéºç”¢ï¼Œå¯çœ‹æµ·", img: "shrine" }, { title: "å‹é€£åŸè·¡", tag: "ä¸­éƒ¨", note: "æœ€å¤è€çš„åŸè·¡ï¼Œ360åº¦ç’°æ™¯", img: "shrine" }, { title: "æµ·ä¸­é“è·¯", tag: "ä¸­éƒ¨", note: "é–‹è»Šåƒåœ¨æµ·ä¸Šè·‘ï¼Œé€£æ¥å››åº§é›¢å³¶", img: "bridge" },
            { title: "ä¼Šè¨ˆå³¶", tag: "ä¸­éƒ¨", note: "æµ·æ°´é€æ˜åº¦æ¥µé«˜ï¼Œé©åˆç©æ°´", img: "okinawa-sea" }, { title: "BIOS ä¹‹ä¸˜", tag: "ä¸­éƒ¨", note: "äºç†±å¸¶æ£®æ—éŠèˆ¹ï¼Œé©åˆè¦ªå­", img: "snorkeling" }, { title: "King Tacos", tag: "ä¸­éƒ¨", note: "å¡”å¯é£¯ç™¼æºåœ°ï¼Œä»½é‡å·¨å¤§", img: "food-taco" }, { title: "æ¿±å±‹æ‹‰éºµ", tag: "ä¸­éƒ¨", note: "è»Ÿéª¨éºµè¶…æœ‰åï¼Œå°±åœ¨æµ·å²¸æ—", img: "food-taco" },
            { title: "åœ‹éš›é€š", tag: "å—éƒ¨", note: "æœ€ç†±é¬§çš„è³¼ç‰©è¡—ï¼Œä¼´æ‰‹ç¦®ä¸€æ¢è¡—", img: "kokusai" }, { title: "ç¬¬ä¸€ç‰§å¿—å…¬è¨­å¸‚å ´", tag: "å—éƒ¨", note: "æ²–ç¹©äººçš„å»šæˆ¿ï¼Œä¸€æ¨“è²·æµ·é®®äºŒæ¨“ç…®", img: "market" }, { title: "æ³¢ä¸Šå®®", tag: "å—éƒ¨", note: "å»ºåœ¨æ‡¸å´–ä¸Šçš„ç¥ç¤¾ï¼Œæœ‰æµ·ç˜", img: "shrine" }, { title: "ç€¨é•·å³¶ Umikaji", tag: "å—éƒ¨", note: "å¸Œè‡˜é¢¨æƒ…ç™½è‰²éšæ¢¯ï¼Œçœ‹é£›æ©Ÿèµ·é™", img: "senaga" }, { title: "ç‰æ³‰æ´", tag: "å—éƒ¨", note: "å£¯è§€çš„é˜ä¹³çŸ³æ´èˆ‡å¤ªé¼“è¡¨æ¼”", img: "night-view" },
            { title: "çŸ¥å¿µå²¬å…¬åœ’", tag: "å—éƒ¨", note: "180åº¦ç„¡æ•µæµ·æ™¯ï¼Œé©åˆçœ‹æ—¥å‡º", img: "okinawa-sea" }, { title: "é½‹å ´å¾¡å¶½", tag: "å—éƒ¨", note: "æ²–ç¹©åœ°ä½æœ€é«˜çš„è–åœ°ï¼Œä¸–ç•Œéºç”¢", img: "shrine" }, { title: "å¥§æ­¦å³¶", tag: "å—éƒ¨", note: "è²“å’ªä¹‹å³¶ï¼Œå¿…åƒä¸­æœ¬å¤©å©¦ç¾…", img: "food-taco" }, { title: "å¹³å’Œç¥ˆå¿µå…¬åœ’", tag: "å—éƒ¨", note: "èŠåš´è‚…ç©†ï¼Œæµ·æ™¯é¼é—Š", img: "shrine" }, { title: "ç³¸æ»¿é­šå¸‚å ´", tag: "å—éƒ¨", note: "æ–°é®®ç”Ÿé­šç‰‡ã€ç„—çƒ¤é¾è¦ç¾åƒ", img: "market" },
            { title: "iias æ²–ç¹©è±å´", tag: "å—éƒ¨", note: "æœ€æ–°å•†å ´ï¼Œå°±åœ¨ DMM æ°´æ—é¤¨æ—", img: "parco" }, { title: "DMM æ°´æ—é¤¨", tag: "å—éƒ¨", note: "è²å…‰æ•ˆæœå¼·ï¼Œå¯é¤µé£Ÿæ¨¹æ‡¶", img: "aquarium" }, { title: "Ashibinaa Outlet", tag: "å—éƒ¨", note: "åç‰ŒæŠ˜æ‰£ï¼Œå°±åœ¨æ©Ÿå ´é™„è¿‘", img: "outlet" }, { title: "è­˜ååœ’", tag: "å—éƒ¨", note: "ç‰çƒç‹å®¤çš„åº­åœ’ï¼Œä¸–ç•Œéºç”¢", img: "shrine" }, { title: "é¦–é‡ŒåŸå…¬åœ’", tag: "å—éƒ¨", note: "ç‰çƒç‹åœ‹çš„è±¡å¾µ (ä¿®å¾©ä¸­ä½†å¯åƒè§€)", img: "shrine" },
            { title: "é€šå ‚æ‹‰éºµ", tag: "ç¾é£Ÿ", note: "ç”·äººéºµ(è±šéª¨)èˆ‡å¥³äººéºµ(é›æ¹¯)", img: "food-taco" }, { title: "æš–æš®æ‹‰éºµ", tag: "ç¾é£Ÿ", note: "ä¹å·ç³»æ‹‰éºµï¼Œå°ç£äººæœ€æ„›", img: "food-taco" }, { title: "å‚‘å…‹ç‰›æ’", tag: "ç¾é£Ÿ", note: "ç¾å¼å¾©å¤é¢¨ï¼Œç‡Ÿæ¥­åˆ°æ·±å¤œ", img: "beef" }, { title: "æ•˜æ•˜è‹‘ç‡’è‚‰", tag: "ç¾é£Ÿ", note: "é«˜ç´šæ™¯è§€ç‡’è‚‰", img: "beef" }, { title: "å¹¸ç¦é¬†é¤…", tag: "ç¾é£Ÿ", note: "ç€¨é•·å³¶å¿…åƒï¼Œéœ€æå‰é ç´„", img: "coffee" }, { title: "Blue Seal", tag: "ç¾é£Ÿ", note: "æ²–ç¹©å¿…åƒç´…èŠ‹/é¹½é‡‘æ¥šç³•å£å‘³", img: "american-village" },
            { title: "A&W æ¼¢å ¡", tag: "ç¾é£Ÿ", note: "ç¾å¼å¾©å¤é€Ÿé£Ÿï¼Œå¿…å–éº¥æ ¹æ²™å£«", img: "food-taco" }, { title: "è±¬è‚‰è›‹é£¯ç³°", tag: "ç¾é£Ÿ", note: "æ©Ÿå ´èˆ‡åœ‹éš›é€šéƒ½æœ‰ï¼Œæ’éšŠååº—", img: "food-taco" }, { title: "oHacorte æ°´æœå¡”", tag: "ç¾é£Ÿ", note: "ç²¾ç·»æ°´æœå¡”ï¼Œæ¸¯å·å¤–äººä½å®…æœ‰åº—", img: "coffee" },
            { title: "å¤§åœ‹è—¥å¦", tag: "è³¼ç‰©", note: "åƒ¹æ ¼é€šå¸¸æ¯”å”å‰è¨¶å¾·ä¾¿å®œ", img: "donki" }, { title: "å”å‰è¨¶å¾·", tag: "è³¼ç‰©", note: "24Hé©šå®‰æ®¿å ‚", img: "donki" }, { title: "æ¼«ç•«å€‰åº«", tag: "è³¼ç‰©", note: "24HäºŒæ‰‹åº—ï¼Œå…¬ä»”/ç²¾å“æŒ–å¯¶å‹åœ°", img: "shopping-bag" },
            { title: "San-A Main Place", tag: "è³¼ç‰©", note: "é‚£éœ¸æ–°éƒ½å¿ƒï¼Œåœ¨åœ°äººæ„›é€›çš„è¶…å¸‚", img: "supermarket" }, { title: "Parco City", tag: "è³¼ç‰©", note: "æµ¦æ·»è¥¿æµ·å²¸ï¼Œå…¨æ²–ç¹©æœ€å¤§ç™¾è²¨", img: "parco" }, { title: "DFS å…ç¨…åº—", tag: "è³¼ç‰©", note: "åœ‹éš›ç²¾å“å…ç¨…ï¼Œéœ€å»æ©Ÿå ´æè²¨", img: "shopping-bag" }
        ];

        // å®Œæ•´ 6 å¤©è¡Œç¨‹ (Data Restored)
        window.DEFAULT_ITINERARY_EVENTS_SOURCE = [
            { dayIndex: 0, events: [{ time: "09:20", title: "æŠµé”é‚£éœ¸æ©Ÿå ´ & å–è»Š", note: "é è¨ˆå‡ºé—œ+å–è»Šç´„1.5å°æ™‚", cost: "ç§Ÿè»Šè²»å¦è¨ˆ", imgKey: "airport", mapUrl: "é‚£éœ¸æ©Ÿå ´ ç§Ÿè»Šæ¥é§è»Š" }, { time: "11:30", title: "åˆé¤ï¼šç³»æ»¿é­šå¸‚å ´", note: "æ¨è–¦ï¼šç„—çƒ¤é¾è¦ã€ç”Ÿè ”", cost: "Â¥1,500~", imgKey: "market", nearby: ["iias è±å´å•†å ´"], mapUrl: "ç³»æ»¿é­šå¸‚å ´" }, { time: "14:00", title: "Check-in ç¾åœ‹æ‘é£¯åº—", note: "Vessel Hotel æˆ– Lequ", cost: "ä½å®¿è²»", imgKey: "american-village", mapUrl: "Vessel Hotel Campana Okinawa" }, { time: "15:30", title: "Snoopy's Surf Shop", note: "è³¼è²·æ²–ç¹©é™å®šTæ¤", cost: "Â¥3,000+", imgKey: "american-village", mapUrl: "Snoopy's Surf Shop Okinawa" }, { time: "18:00", title: "æ™šé¤ï¼šTaco Rice Cafe", note: "å¿…åƒæ­å§†è›‹å¡”å¯é£¯", cost: "Â¥1,200", imgKey: "food-taco", mapUrl: "Taco Rice Cafe Kijimuna Depot Island" }, { time: "20:00", title: "ç¾åœ‹æ‘å¤œæ™¯æ•£æ­¥", note: "æ²¿è‘—æµ·å ¤æ­¥é“", cost: "å…è²»", imgKey: "night-view", nearby: ["Chatan Harbor Brewery"], mapUrl: "Depot Island Boardwalk" }, { time: "21:30", title: "AEON åŒ—è°·åº— (è£œçµ¦)", note: "è²·å¤§ç½èŒ¶ã€æ°´æœã€æ˜å¤©æ—©é¤", cost: "Â¥1,500", imgKey: "supermarket", mapUrl: "AEON Chatan" }] },
            { dayIndex: 1, events: [{ time: "08:00", title: "é’ä¹‹æ´çªŸæµ®æ½›", note: "å¥—è£è¡Œç¨‹é€šå¸¸å«è£å‚™", cost: "Â¥4,000", imgKey: "snorkeling", mapUrl: "å‰ç”°å²¬ é’ä¹‹æ´çªŸ" }, { time: "11:30", title: "åˆé¤ï¼šPizzeria da ENZO", note: "çª¯çƒ¤æŠ«è–©ã€ç¾©å¤§åˆ©éºµ", cost: "Â¥2,000", imgKey: "pizza", mapUrl: "Pizzeria da ENZO Okinawa" }, { time: "13:30", title: "Nabee Beach ç©æ°´", note: "æµ·ç˜å…è²»ï¼Œæ´»å‹•å¦è¨ˆ", cost: "å…è²»", imgKey: "okinawa-sea", mapUrl: "Nabee Beach Okinawa" }, { time: "19:00", title: "æ™šé¤ï¼šç‰çƒä¹‹ç‰›", note: "é ‚ç´šé»‘æ¯›å’Œç‰›å¥—é¤", cost: "Â¥8,000", imgKey: "beef", mapUrl: "Ryukyu No Ushi Onna" }, { time: "21:45", title: "æ©ç´æ‘æµ·ç˜è§€æ˜Ÿ", note: "é€™è£¡å…‰å®³å°‘", cost: "å…è²»", imgKey: "night-view", mapUrl: "Onna Seaside Civil Park" }] },
            { dayIndex: 2, events: [{ time: "11:00", title: "å¤å®‡åˆ©å¤§æ©‹", note: "æ²–ç¹©è—", cost: "å…è²»", imgKey: "bridge", mapUrl: "å¤å®‡åˆ©å¤§æ©‹ å—ç«¯å±•æœ›æ‰€" }, { time: "12:00", title: "åˆé¤ï¼šè¦è¦é£¯", note: "ç¶“å…¸è’œå‘³è¦é£¯", cost: "Â¥1,500", imgKey: "food-taco", mapUrl: "Kouri Shrimp" }, { time: "14:00", title: "ç¾éº—æµ·æ°´æ—é¤¨", note: "æˆäººç¥¨åƒ¹", cost: "Â¥2,180", imgKey: "aquarium", mapUrl: "æ²–ç¹©ç¾éº—æµ·æ°´æ—é¤¨ P7åœè»Šå ´" }, { time: "17:30", title: "è¬åº§æ¯›å¤•é™½", note: "å…¥å ´é–€ç¥¨", cost: "Â¥100", imgKey: "okinawa-sea", mapUrl: "è¬åº§æ¯›" }, { time: "19:00", title: "æ™šé¤ï¼šé˜¿å¤è±¬æ¶®æ¶®é‹", note: "å“åšæ²–ç¹©ç‰¹ç”¢è±¬è‚‰", cost: "Â¥4,000", imgKey: "food-taco", mapUrl: "Agu Pork Shabu Shabu Onna" }, { time: "21:00", title: "å±…é…’å±‹äºŒæ¬¡æœƒ", note: "Orion å•¤é…’", cost: "Â¥3,000", imgKey: "beer", mapUrl: "Onna Village Izakaya" }] },
            { dayIndex: 3, events: [{ time: "11:00", title: "PARCO CITY", note: "åˆé¤+è³¼ç‰©", cost: "å€‹äººé ç®—", imgKey: "parco", mapUrl: "PARCO CITY Okinawa" }, { time: "19:00", title: "æ™šé¤ï¼šæš–æš®æ‹‰éºµ", note: "æ‹‰éºµ+é¤ƒå­", cost: "Â¥1,200", imgKey: "food-taco", mapUrl: "æš–æš®æ‹‰éºµ é‚£éœ¸ç‰§å¿—åº—" }, { time: "20:30", title: "å”å‰è¨¶å¾· (åœ‹éš›é€š)", note: "24H è—¥å¦æ¡è³¼", cost: "Â¥10,000+", imgKey: "donki", mapUrl: "Don Quijote Kokusai Dori" }] },
            { dayIndex: 4, events: [{ time: "09:30", title: "æ³¢ä¸Šå®®", note: "è²·æ›¸åŒ…å¾¡å®ˆ", cost: "Â¥800", imgKey: "shrine", mapUrl: "æ³¢ä¸Šå®®" }, { time: "14:00", title: "å£ºå±‹é€š/æµ®å³¶é€š", note: "æ–‡é’ä¸‹åˆèŒ¶", cost: "Â¥1,200", imgKey: "coffee", mapUrl: "å£ºå±‹Yachimuné€š" }, { time: "19:00", title: "åœ‹éš›é€šå±‹å°æ‘", note: "é«”é©—è·¯é‚Šæ”¤æ°£æ°›", cost: "Â¥3,500", imgKey: "food-taco", mapUrl: "åœ‹éš›é€šå±‹å°æ‘" }, { time: "20:30", title: "San-A è¶…å¸‚ä¼´æ‰‹ç¦®", note: "è²·æ³¡éºµã€è¾£æ²¹", cost: "Â¥4,000", imgKey: "supermarket", mapUrl: "San-A Naha Main Place" }, { time: "22:00", title: "å®µå¤œï¼šå‚‘å…‹ç‰›æ’", note: "ç´ç´„å®¢ç‰›æ’", cost: "Â¥3,000", imgKey: "beef", mapUrl: "Jack's Steak House Okinawa" }] },
            { dayIndex: 5, events: [{ time: "11:00", title: "Ashibinaa Outlet", note: "æœ€å¾Œè³¼ç‰©", cost: "å€‹äººé ç®—", imgKey: "outlet", mapUrl: "Ashibinaa Outlet" }, { time: "19:40", title: "æ©Ÿå ´å…ç¨…åº—", note: "æ¶ˆè€—å‰©é¤˜æ—¥å¹£", cost: "ALL IN", imgKey: "airport", mapUrl: "é‚£éœ¸æ©Ÿå ´ åœ‹éš›ç·šèˆªå»ˆ" }] }
        ];

        // --- Renderers ---
        function renderItinerary(c) {
             if(window.state.itineraryEvents.length === 0) {
                 c.innerHTML = `<div class="bg-slate-800 rounded-xl p-6 text-center border border-slate-700 mt-10"><i data-lucide="cloud-rain" class="mx-auto text-slate-500 mb-2" width="48"></i><h3 class="text-lg font-bold text-white mb-2">è¡Œç¨‹è¡¨ç›®å‰æ˜¯ç©ºçš„</h3><p class="text-slate-400 text-sm mb-4">æ‚¨å¯ä»¥é¸æ“‡ä¸Šå‚³é è¨­è¡Œç¨‹ï¼Œæˆ–æ˜¯å¾é ­é–‹å§‹æ–°å¢ã€‚</p><button onclick="window.uploadDefaultItinerary()" class="bg-indigo-600 hover:bg-indigo-500 text-white px-4 py-2 rounded-lg font-medium flex items-center justify-center gap-2 mx-auto"><i data-lucide="upload-cloud" width="18"></i> â˜ï¸ ä¸Šå‚³é è¨­è¡Œç¨‹</button></div>`;
                 return;
             }
             DAYS_STRUCTURE.forEach((d, i) => {
                const evs = window.state.itineraryEvents.filter(e => e.dayIndex === i).sort((a,b) => a.time.localeCompare(b.time));
                const card = document.createElement('div');
                card.className = "bg-[#1e293b] rounded-xl shadow-lg border border-slate-700/60 overflow-hidden mb-5";
                let evHtml = evs.length===0 ? `<div class="p-4 text-center text-xs text-slate-500">æ­¤æ—¥å°šç„¡è¡Œç¨‹</div>` : evs.map(e => {
                    const ex = window.state.expandedId === e.id;
                    const isLate = e.time >= "20:00";
                    const img = getImageUrl(e.imgKey);
                    const map = getSafeMapLink(e.mapUrl);
                    return `<div onclick="window.toggleExpand('${e.id}')" class="flex items-center gap-4 px-4 py-3.5 cursor-pointer transition-all ${ex?'bg-indigo-900/20 pb-4':'hover:bg-slate-800'}"><div class="w-12 text-right text-sm font-mono font-bold ${isLate?'text-yellow-400':'text-indigo-400'}">${e.time}</div><div class="grow min-w-0"><h3 class="font-bold text-[15px] ${isLate?'text-yellow-100':'text-slate-200'}">${e.title}</h3>${!ex?`<div class="flex justify-between mt-1"><p class="text-xs text-slate-500 truncate">${e.note}</p>${e.cost?`<span class="text-[10px] text-emerald-500 bg-emerald-900/20 px-1 rounded ml-2 whitespace-nowrap">${e.cost}</span>`:''}</div>`:''}</div><div class="text-slate-500"><i data-lucide="${ex?'chevron-up':'chevron-down'}" width="16"></i></div></div>${ex?`<div class="px-4 pl-[4.5rem] fade-in"><div class="relative h-32 rounded-lg overflow-hidden mb-3"><img src="${img}" class="w-full h-full object-cover opacity-80" />${isLate?'<div class="absolute top-2 right-2 bg-black/60 text-yellow-300 text-[10px] px-2 py-0.5 rounded-full flex items-center gap-1 border border-yellow-500/30"><i data-lucide="moon" width="10"></i> Night Life</div>':''}</div><div class="space-y-2 mb-3">${e.cost?`<div class="inline-flex items-center gap-2 bg-emerald-900/30 text-emerald-300 px-3 py-1.5 rounded text-sm font-mono border border-emerald-500/20"><i data-lucide="wallet" width="14"></i> é ä¼°: ${e.cost}</div>`:''}<div class="bg-slate-800 p-2.5 rounded text-sm text-slate-300 flex gap-2"><i data-lucide="info" width="14" class="mt-1 shrink-0 text-indigo-400"></i> ${e.note}</div></div><div class="flex justify-between pt-2 border-t border-slate-700"><a href="${map}" target="_blank" class="flex items-center gap-1 text-xs bg-indigo-600 text-white px-3 py-1.5 rounded"><i data-lucide="navigation" width="12"></i> å°èˆª</a><button onclick="window.deleteCloudItin('${e.id}')" class="text-slate-500 hover:text-red-400 flex items-center gap-1 text-xs"><i data-lucide="trash-2" width="14"></i> åˆªé™¤</button></div></div>`:''}`;
                }).join('');
                const ac = window.state.isAddingItinerary === i 
                    ? `<form onsubmit="window.submitItinerary(event, ${i})" class="bg-slate-800 p-3 rounded border border-indigo-500/30 space-y-2 fade-in"><div class="flex gap-2"><input type="text" name="time" class="w-1/3 bg-slate-700 border-slate-600 rounded text-sm p-2 text-white" required><input type="text" name="title" placeholder="æ¨™é¡Œ" class="w-2/3 bg-slate-700 border-slate-600 rounded text-sm p-2 text-white" required></div><div class="flex gap-2"><input type="text" name="cost" placeholder="èŠ±è²»" class="w-1/3 bg-slate-700 border-slate-600 rounded text-sm p-2 text-white"><input type="text" name="note" placeholder="å‚™è¨»" class="w-2/3 bg-slate-700 border-slate-600 rounded text-sm p-2 text-white"></div><div class="flex justify-end gap-2"><button type="button" onclick="window.cancelAddItin()" class="px-3 py-1 text-xs text-slate-400">å–æ¶ˆ</button><button type="submit" class="px-3 py-1 text-xs bg-indigo-600 text-white rounded">ç¢ºèª</button></div></form>`
                    : `<button onclick="window.showAddItin(${i})" class="w-full py-2 text-xs text-slate-400 border border-dashed border-slate-700 rounded hover:bg-slate-800 flex justify-center items-center gap-1"><i data-lucide="plus" width="14"></i> æ–°å¢è¡Œç¨‹</button>`;
                card.innerHTML = `<div class="bg-gradient-to-r from-slate-800 to-[#1e293b] px-4 py-3 border-b border-slate-700 flex items-center gap-3"><div class="bg-indigo-600 text-white p-2 rounded-lg"><i data-lucide="${d.icon}" width="20"></i></div><div><h2 class="font-bold text-indigo-100">${d.date}</h2><p class="text-xs text-indigo-300/80">${d.title}</p></div></div><div class="divide-y divide-slate-700/50">${evHtml}</div><div class="p-3 bg-slate-800/30">${ac}</div>`;
                c.appendChild(card);
            });
        }

        function renderBackup(c) {
            const lst = window.state.backupEvents.length===0?`<div class="p-8 text-center text-slate-500 text-sm">ç›®å‰æ²’æœ‰å‚™æ¡ˆï¼Œé»æ“Šä¸‹æ–¹æ–°å¢</div>`:window.state.backupEvents.map(e=>`<div class="p-4 hover:bg-slate-800 transition-colors group"><div class="flex items-start gap-3"><div class="bg-slate-700 p-2 rounded text-slate-300"><i data-lucide="map-pin" width="16"></i></div><div class="grow"><div class="flex justify-between items-start"><h3 class="font-bold text-slate-200 text-sm">${e.title}</h3>${e.tag?`<span class="text-[10px] bg-slate-700 text-slate-400 px-1.5 py-0.5 rounded">${e.tag}</span>`:''}</div><p class="text-xs text-slate-500 mt-1">${e.note}</p><div class="flex gap-2 mt-2"><button onclick="window.addToItinFromBackup('${e.id}','${e.title}','${e.note}')" class="flex-1 bg-indigo-600 hover:bg-indigo-500 text-white text-[10px] py-1.5 rounded transition-colors flex items-center justify-center gap-1"><i data-lucide="calendar-plus" width="12"></i> æ’å…¥è¡Œç¨‹</button><a href="${getSafeMapLink(e.title)}" target="_blank" class="bg-slate-700 hover:bg-slate-600 px-2 py-1 rounded text-slate-300 flex items-center gap-1"><i data-lucide="navigation" width="12"></i></a><button onclick="window.deleteCloudBackup('${e.id}')" class="text-slate-600 hover:text-red-400 px-2 flex items-center"><i data-lucide="trash-2" width="12"></i></button></div></div></div></div>`).join('');
            const af = window.state.isAddingBackup?`<form onsubmit="window.submitBackup(event)" class="bg-slate-800 p-3 rounded border border-pink-500/30 space-y-2 fade-in"><div class="flex gap-2"><input type="text" name="title" placeholder="æ™¯é»åç¨±" class="w-2/3 bg-slate-700 border-slate-600 rounded text-sm p-2 text-white" required><input type="text" name="tag" placeholder="æ¨™ç±¤" class="w-1/3 bg-slate-700 border-slate-600 rounded text-sm p-2 text-white"></div><input type="text" name="note" placeholder="å‚™è¨»èªªæ˜" class="w-full bg-slate-700 border-slate-600 rounded text-sm p-2 text-white"><div class="flex justify-end gap-2"><button type="button" onclick="window.cancelAddBackup()" class="px-3 py-1 text-xs text-slate-400">å–æ¶ˆ</button><button type="submit" class="px-3 py-1 text-xs bg-pink-600 text-white rounded">ç¢ºèª</button></div></form>`:`<button onclick="window.showAddBackup()" class="w-full py-2 text-xs text-slate-400 border border-dashed border-slate-700 rounded hover:bg-slate-800 flex justify-center items-center gap-1"><i data-lucide="plus" width="14"></i> æ–°å¢å‚™æ¡ˆ</button>`;
            const card=document.createElement('div'); card.className="bg-[#1e293b] rounded-xl shadow-lg border border-slate-700/60 overflow-hidden"; card.innerHTML=`<div class="bg-gradient-to-r from-pink-900/50 to-[#1e293b] px-4 py-3 border-b border-slate-700 flex items-center gap-3"><div class="bg-pink-600 text-white p-2 rounded-lg"><i data-lucide="folder-open" width="20"></i></div><div><h2 class="font-bold text-pink-100">å£è¢‹åå–® & å‚™æ¡ˆ</h2><p class="text-xs text-pink-300/80">æš«æœªå®‰æ’çš„æ™¯é»</p></div></div><div class="divide-y divide-slate-700/50">${lst}</div><div class="p-3 bg-slate-800/30">${af}</div>`; c.appendChild(card);
        }

        function renderRecommend(c) {
             const fs=['å…¨éƒ¨','åŒ—éƒ¨','ä¸­éƒ¨','å—éƒ¨','ç¾é£Ÿ','è³¼ç‰©']; const fc=`<div class="flex gap-2 overflow-x-auto pb-4 hide-scrollbar mb-2">${fs.map(f=>`<button onclick="window.setRecommendFilter('${f}')" class="px-4 py-1.5 rounded-full text-xs font-bold whitespace-nowrap transition-colors ${window.state.recommendFilter===f?'bg-blue-500 text-white':'bg-slate-800 text-slate-400 border border-slate-700'}">${f}</button>`).join('')}</div>`;
             const sp=window.state.recommendFilter==='å…¨éƒ¨'?RECOMMENDED_SPOTS:RECOMMENDED_SPOTS.filter(s=>s.tag.includes(window.state.recommendFilter));
             const gc=sp.map(s=>`<div class="bg-[#1e293b] rounded-lg border border-slate-700 p-3 flex flex-col"><h3 class="font-bold text-sm text-slate-200 mb-1">${s.title}</h3><p class="text-[10px] text-slate-500 line-clamp-2 mb-3 grow">${s.note}</p><div class="flex gap-2 mt-auto"><a href="${getSafeMapLink(s.title)}" target="_blank" class="flex-1 bg-slate-700 hover:bg-slate-600 text-slate-300 text-[10px] py-1.5 rounded flex items-center justify-center gap-1"><i data-lucide="search" width="12"></i> æœå°‹</a><button onclick="window.addToBackupFromRec('${s.title}','${s.tag}','${s.note}')" class="flex-1 bg-blue-600 hover:bg-blue-500 text-white text-[10px] py-1.5 rounded flex items-center justify-center gap-1"><i data-lucide="plus" width="12"></i> å‚™æ¡ˆ</button></div></div>`).join('');
             c.innerHTML = fc + `<div class="grid grid-cols-2 gap-3">${gc}</div>`;
        }

        function renderSplit(c) {
            const users = window.state.users;
            const amount = window.state.splitAmount || '';
            const payerId = window.state.splitPayer || users[0].id;
            const targets = window.state.splitTargets || [];
            const curr = window.state.splitCurrency;
            const isJpy = curr === 'JPY';
            let resultHtml = '';
            if(amount && targets.length > 0) {
                const perPerson = Math.round(parseFloat(amount) / targets.length);
                const symbol = curr === 'TWD' ? 'NT$' : 'Â¥';
                const displayAmt = `${symbol}${perPerson.toLocaleString()}`;
                const payer = window.state.users.find(u => u.id === payerId);
                const debtors = targets.filter(uid => uid !== payerId);
                
                let detailHtml = '';
                if(debtors.length === 0) {
                     detailHtml = `<div class="text-xs text-slate-300 mb-2">å®Œå…¨ç”± ${payer.name} è‡ªå·±è² æ“”</div>`;
                } else {
                     detailHtml = debtors.map(uid => {
                        const u = users.find(x => x.id === uid);
                        return `<div class="flex justify-between text-xs text-slate-300 border-b border-amber-700/30 pb-1 mb-1"><span>${u.name} çµ¦ ${payer.name}</span><span class="font-bold text-amber-200">${symbol}${perPerson.toLocaleString()}</span></div>`;
                     }).join('');
                }

                resultHtml = `<div id="split-result-area" class="bg-amber-900/40 border border-amber-600/50 rounded-xl p-4 mt-4 animate-in fade-in"><div class="text-center mb-1 text-amber-200 text-xs">ç¸½é‡‘é¡ ${symbol}${amount.toLocaleString()} / ${targets.length}äºº</div><div class="text-center text-2xl font-bold text-white mb-3">æ¯äººåˆ†æ“” ${displayAmt}</div><div class="bg-black/20 rounded p-2 mb-3 space-y-1">${detailHtml}</div><button onclick="window.submitSplitToAccounting(${perPerson})" class="w-full bg-amber-600 hover:bg-amber-500 text-white py-3 rounded-lg font-bold shadow-lg flex items-center justify-center gap-2 transition-transform active:scale-95"><i data-lucide="save" width="18"></i> å¯«å…¥è¨˜å¸³</button></div>`;
            } else { resultHtml = `<div id="split-result-area"><div class="text-center text-slate-500 text-sm py-4">è¼¸å…¥é‡‘é¡ä¸¦é¸æ“‡åˆ†å¸³å°è±¡...</div></div>`; }
            const isSplitJpy = window.state.splitCurrency === 'JPY';
            c.innerHTML = `<div class="bg-[#1e293b] rounded-xl p-5 border border-slate-700 shadow-md"><h2 class="text-amber-400 text-sm font-bold uppercase mb-4 flex items-center gap-2"><i data-lucide="calculator" width="16"></i> åˆ†å¸³è¨ˆç®—æ©Ÿ</h2><div class="space-y-4"><div><label class="text-xs text-slate-400 mb-1 block">ç¸½é‡‘é¡</label><div class="flex gap-2"><input type="number" id="split-amount-input" value="${amount}" oninput="window.updateSplitCalc(this.value)" class="w-2/3 bg-slate-900 border border-slate-600 rounded-lg p-3 text-xl text-white text-center focus:border-amber-500 outline-none" placeholder="0"><div class="w-1/3 flex bg-slate-800 rounded-lg border border-slate-600 p-1"><button onclick="window.setSplitCurrency('JPY')" class="flex-1 text-xs rounded ${isSplitJpy?'bg-amber-600 text-white':'text-slate-400'}">æ—¥å¹£</button><button onclick="window.setSplitCurrency('TWD')" class="flex-1 text-xs rounded ${!isSplitJpy?'bg-indigo-600 text-white':'text-slate-400'}">å°å¹£</button></div></div></div><div><label class="text-xs text-slate-400 mb-2 block">èª°å…ˆå¢ŠéŒ¢ï¼Ÿ</label><div class="flex gap-2">${users.map(u => `<button onclick="window.setSplitPayer('${u.id}')" class="flex-1 py-2 rounded-lg text-xs transition-all ${payerId===u.id ? `${u.color} text-white ring-2 ring-white` : 'bg-slate-800 text-slate-400 border border-slate-600'}">${u.name}</button>`).join('')}</div></div><div><label class="text-xs text-slate-400 mb-2 block">åˆ†çµ¦èª°ï¼Ÿ (é»æ“Šé¸æ“‡)</label><div class="grid grid-cols-2 gap-2">${users.map(u => { const isSelected = targets.includes(u.id); return `<button onclick="window.toggleSplitTarget('${u.id}')" class="py-2 rounded-lg text-xs transition-all flex items-center justify-center gap-2 ${isSelected ? 'bg-slate-600 text-white border border-amber-500' : 'bg-slate-800 text-slate-500 border border-slate-700'}"><div class="w-2 h-2 rounded-full ${u.color}"></div> ${u.name} ${isSelected?'âœ“':''}</button>`; }).join('')}</div></div></div>${resultHtml}</div>`;
        }

        function renderAccounting(c) {
            const tj = window.state.expenses.reduce((s,i)=>s+i.amount,0);
            const tt = Math.round(tj/window.state.rate);
            const mh = `<div class="grid grid-cols-4 gap-2 mb-6">${window.state.users.map(u => `<div onclick="window.renameUser('${u.id}')" class="flex flex-col items-center gap-1 cursor-pointer group"><div class="w-10 h-10 rounded-full ${u.color} flex items-center justify-center text-white font-bold shadow-md">${u.name.charAt(0)}</div><div class="flex items-center gap-1"><span class="text-[10px] text-slate-300">${u.name}</span><i data-lucide="edit-3" width="8" class="text-slate-500"></i></div></div>`).join('')}</div>`;
            const sh = `<div class="bg-[#1e293b] rounded-2xl p-4 border border-slate-700 shadow-md mb-6"><h2 class="text-emerald-400 text-xs font-bold uppercase mb-3 flex items-center gap-1"><i data-lucide="pie-chart" width="14"></i> æ”¯å‡ºç¸½è¦½</h2><div class="mb-4 text-center"><span class="text-3xl font-bold text-white">Â¥${tj.toLocaleString()}</span><div class="text-xs text-slate-400">ç´„ NT$ ${tt.toLocaleString()}</div></div><div class="grid grid-cols-2 gap-2">${window.state.users.map(u => { const ut = window.state.expenses.filter(e=>e.userId===u.id).reduce((s,e)=>s+e.amount,0); return `<div class="bg-slate-800/50 rounded p-2 flex items-center justify-between border border-slate-700/50"><div class="flex items-center gap-1.5"><div class="w-2 h-2 rounded-full ${u.color}"></div><span class="text-xs text-slate-300">${u.name}</span></div><span class="text-xs font-mono font-bold ${u.text}">Â¥${ut.toLocaleString()}</span></div>`; }).join('')}</div></div>`;
            const catsHtml = EXPENSE_CATEGORIES.map(c => `<button type="button" onclick="window.setExpCat('${c.id}')" class="flex flex-col items-center gap-1 py-2 rounded-lg transition-all ${window.tempExpCat === c.id ? 'bg-slate-700 text-emerald-400 ring-1 ring-emerald-500' : 'text-slate-500 hover:bg-slate-800'}"><div class="${c.color} text-white p-1.5 rounded-full shadow-sm"><i data-lucide="${c.icon}" width="18"></i></div><span class="text-[10px]">${c.name}</span></button>`).join('');
            const isJpy = window.tempExpCurr === 'JPY';
            const fh = `<div class="bg-[#1e293b] rounded-xl p-4 border border-slate-700 shadow-md mb-6"><h3 class="text-sm font-bold text-slate-300 mb-3 flex items-center gap-2"><i data-lucide="credit-card" width="16"></i> æ–°å¢æ¶ˆè²»</h3><form onsubmit="window.submitExpense(event)" class="space-y-4"><div class="flex gap-2 justify-between bg-slate-800 p-1.5 rounded-lg border border-slate-600">${window.state.users.map(u=>`<button type="button" onclick="window.selectUser('${u.id}')" class="flex-1 py-1.5 text-xs rounded transition-all flex justify-center items-center gap-1 ${window.state.selectedUser===u.id?`${u.color} text-white shadow-sm`:'text-slate-400'}">${u.name}</button>`).join('')}</div><div class="flex gap-2"><div class="relative w-2/3"><input type="number" id="exp-amount" placeholder="0" value="${window.state.formAmount}" oninput="window.syncAmount(this.value)" class="w-full bg-slate-800 border border-slate-600 rounded-lg py-2.5 pl-3 pr-12 text-lg text-white font-mono focus:border-emerald-500 outline-none"><span class="absolute right-3 top-3 text-xs text-slate-400" id="exp-curr-label">${window.tempExpCurr}</span></div><div class="w-1/3 flex bg-slate-800 rounded-lg border border-slate-600 p-1"><button type="button" onclick="window.setExpCurr('JPY')" class="flex-1 text-xs rounded ${isJpy?'bg-emerald-600 text-white':'text-slate-400'}">æ—¥å¹£</button><button type="button" onclick="window.setExpCurr('TWD')" class="flex-1 text-xs rounded ${!isJpy?'bg-indigo-600 text-white':'text-slate-400'}">å°å¹£</button></div></div><div class="grid grid-cols-6 gap-2" id="cat-grid">${catsHtml}</div><div class="flex gap-2"><input type="text" id="exp-note" placeholder="å‚™è¨»" value="${window.state.formNote}" oninput="window.syncNote(this.value)" class="grow bg-slate-800 border border-slate-600 rounded-lg px-3 text-sm text-white focus:border-emerald-500 outline-none"><button type="submit" class="bg-emerald-600 hover:bg-emerald-500 text-white p-2.5 rounded-lg shadow-lg"><i data-lucide="plus" width="20"></i></button></div></form></div>`;
            
            const lh = `<h3 class="text-xs font-bold text-slate-500 uppercase tracking-wider pl-1 mb-3">æœ€è¿‘ç´€éŒ„ (é»æ“Šå±•é–‹)</h3><div class="space-y-3">${window.state.expenses.length===0 ? `<div class="text-center py-8 text-slate-600 text-sm">å°šç„¡ç´€éŒ„</div>` : window.state.expenses.map(i => { 
                const cat=EXPENSE_CATEGORIES.find(c=>c.id===i.cat)||EXPENSE_CATEGORIES[0]; 
                const u=window.state.users.find(x=>x.id===i.userId)||window.state.users[0]; 
                const isEx = window.state.expandedExpenseId === i.id;
                return `<div onclick="window.toggleExpandExpense('${i.id}')" class="bg-[#1e293b] border ${u.border} border-l-4 rounded-lg shadow-sm fade-in transition-all cursor-pointer overflow-hidden"><div class="p-3 flex items-center gap-3"><div class="shrink-0 ${cat.color} text-white p-2 rounded-full"><i data-lucide="${cat.icon}" width="18"></i></div><div class="grow min-w-0"><div class="flex justify-between items-baseline"><span class="font-bold text-slate-200 ${isEx ? '' : 'truncate'}">${i.note||cat.name}</span><span class="font-mono font-bold text-white ml-2">Â¥${i.amount.toLocaleString()}</span></div><div class="flex justify-between items-center mt-1"><span class="text-[10px] px-1.5 rounded bg-slate-800 ${u.text}">${u.name}</span><div class="flex items-center gap-1"><span class="text-[10px] text-slate-500">â‰ˆ NT$ ${Math.round(i.amount/window.state.rate)}</span><i data-lucide="${isEx?'chevron-up':'chevron-down'}" width="14" class="text-slate-500"></i></div></div></div></div>${isEx ? `<div class="px-3 pb-3 pt-0 border-t border-slate-700/50 bg-slate-800/20 animate-in slide-in-from-top-1"><div class="mt-2 text-xs text-slate-400 space-y-1"><div class="flex justify-between"><span>åˆ†é¡:</span> <span>${cat.name}</span></div><div class="flex justify-between"><span>æ™‚é–“:</span> <span>${new Date(i.timestamp).toLocaleString()}</span></div><div class="pt-2 text-sm text-slate-300 whitespace-pre-wrap border-t border-slate-700/30 mt-2">${i.note || '(ç„¡å‚™è¨»)'}</div></div><div class="mt-3 flex justify-end"><button onclick="event.stopPropagation(); window.deleteCloudExpense('${i.id}')" class="text-xs bg-red-900/30 text-red-400 hover:bg-red-900/50 px-3 py-1.5 rounded border border-red-900/50 flex items-center gap-1 transition-colors"><i data-lucide="trash-2" width="14"></i> åˆªé™¤æ­¤ç´€éŒ„</button></div></div>` : ''}</div>`; 
            }).join('')}</div>`;
            c.innerHTML = mh + sh + fh + lh;
        }

        // --- Handlers ---
        window.toggleExpand=(id)=>{window.state.expandedId=window.state.expandedId===id?null:id;renderContent();}
        window.toggleExpandExpense=(id)=>{window.state.expandedExpenseId=window.state.expandedExpenseId===id?null:id;renderContent();lucide.createIcons();}
        window.selectUser=(id)=>{window.state.selectedUser=id;renderContent();}
        window.setRecommendFilter=(f)=>{window.state.recommendFilter=f;renderContent();}
        window.setExpCurr=(c)=>{window.tempExpCurr=c;renderContent();}
        window.setExpCat=(c)=>{window.tempExpCat=c;renderContent();}
        window.syncAmount=(v)=>{window.state.formAmount=v;}
        window.syncNote=(v)=>{window.state.formNote=v;}
        window.submitExpense=(e)=>{e.preventDefault();const a=window.state.formAmount,n=window.state.formNote;if(!a){alert("è«‹è¼¸å…¥é‡‘é¡");return;}let v=parseFloat(a);if(window.tempExpCurr==='TWD')v=Math.round(v*window.state.rate);window.addCloudExpense({amount:v,cat:window.tempExpCat,note:n,userId:window.state.selectedUser});window.state.formAmount='';window.state.formNote='';renderContent();}
        window.deleteCloudExpense=(id)=>{if(confirm("åˆªé™¤?"))window.expensesRef.doc(id).delete();}
        window.renameUser=(id)=>{const u=window.state.users.find(x=>x.id===id),n=prompt("æ–°æš±ç¨±:",u.name);if(n){const l=window.state.users.map(x=>x.id===id?{...x,name:n}:x);window.updateCloudUser(l);}}
        window.toggleConverter=()=>{document.getElementById('converter-panel').classList.toggle('hidden');}
        window.convertCurrency=(t)=>{const j=document.getElementById('conv-jpy'),tw=document.getElementById('conv-twd');if(t==='jpy')tw.value=j.value?Math.round(j.value/window.state.rate):'';else j.value=tw.value?Math.round(tw.value*window.state.rate):'';}
        window.showAddItin=(d)=>{window.state.isAddingItinerary=d;renderContent();}
        window.cancelAddItin=()=>{window.state.isAddingItinerary=null;renderContent();}
        window.submitItinerary=(e,d)=>{e.preventDefault();const f=new FormData(e.target);window.addCloudItineraryEvent(d,{time:f.get('time'),title:f.get('title'),note:f.get('note'),cost:f.get('cost'),mapUrl:f.get('title'),imgKey:'default'});window.state.isAddingItinerary=null;renderContent();}
        window.deleteCloudItin=(id)=>{if(confirm("åˆªé™¤?"))window.itineraryRef.doc(id).delete();}
        window.showAddBackup=()=>{window.state.isAddingBackup=true;renderContent();}
        window.cancelAddBackup=()=>{window.state.isAddingBackup=false;renderContent();}
        window.submitBackup=(e)=>{e.preventDefault();const f=new FormData(e.target);window.addCloudBackupEvent({title:f.get('title'),tag:f.get('tag'),note:f.get('note')});window.state.isAddingBackup=false;renderContent();}
        window.deleteCloudBackup=(id)=>{if(confirm("åˆªé™¤?"))window.backupRef.doc(id).delete();}
        window.addToBackupFromRec=(t,g,n)=>{if(confirm(`åŠ å…¥ã€Œ${t}ã€?`))window.addCloudBackupEvent({title:t,tag:g,note:n});}
        window.addToItinFromBackup=(id,t,n)=>{const d=prompt("ç¬¬å¹¾å¤©(1-6)?");if(!d)return;const di=parseInt(d)-1;const tm=prompt("æ™‚é–“?","10:00");if(!tm)return;window.addCloudItineraryEvent(di,{time:tm,title:t,note:n,cost:"",mapUrl:t,imgKey:'default'});if(confirm("å¾å‚™æ¡ˆç§»é™¤?"))window.backupRef.doc(id).delete();}
        window.uploadDefaultItinerary=async()=>{if(!confirm("ä¸Šå‚³?"))return;const b=window.db.batch();window.DEFAULT_ITINERARY_EVENTS_SOURCE.forEach(d=>{d.events.forEach(e=>{const r=window.itineraryRef.doc();b.set(r,{...e,dayIndex:d.dayIndex,timestamp:Date.now()});});});b.commit().then(()=>alert("å®Œæˆ!"));}
        window.updateSplitCalc=(v)=>{window.state.splitAmount=v;renderContent();}
        window.setSplitPayer=(id)=>{window.state.splitPayer=id;if(!window.state.splitTargets.includes(id))window.state.splitTargets.push(id);renderContent();const e=document.getElementById('split-amount-input');if(e){e.value=window.state.splitAmount;e.focus();window.updateSplitCalc(e.value);}}
        window.toggleSplitTarget=(id)=>{const i=window.state.splitTargets.indexOf(id);if(i>-1)window.state.splitTargets.splice(i,1);else window.state.splitTargets.push(id);renderContent();const e=document.getElementById('split-amount-input');if(e){e.value=window.state.splitAmount;e.focus();window.updateSplitCalc(e.value);}}
        window.setSplitCurrency=(c)=>{window.state.splitCurrency=c;renderContent();const e=document.getElementById('split-amount-input');if(e){e.value=window.state.splitAmount;e.focus();window.updateSplitCalc(e.value);}}
        window.submitSplitToAccounting=(pp)=>{if(confirm('å¯«å…¥è¨˜å¸³ï¼Ÿ')){const payer=window.state.users.find(u=>u.id===window.state.splitPayer);const tgs=window.state.users.filter(u=>window.state.splitTargets.includes(u.id)).map(u=>u.name).join(', ');let val=parseFloat(window.state.splitAmount);const c=window.state.splitCurrency;const s=c==='TWD'?`NT$${pp}`:`Â¥${pp}`;let note=`åˆ†å¸³: ç¸½é¡${c==='TWD'?'NT$':'Â¥'}${val} (æ¯äºº${s})`;if(c==='TWD')val=Math.round(val*window.state.rate);window.addCloudExpense({amount:val,cat:'food',note:note,userId:window.state.splitPayer});window.state.splitAmount='';alert("å®Œæˆ!");renderContent();}}
        window.exportCSV = function() {
            if(window.state.expenses.length === 0) { alert("æ²’æœ‰è¨˜å¸³è³‡æ–™å¯åŒ¯å‡º"); return; }
            let csvContent = "\uFEFF";
            csvContent += "æ—¥æœŸ,ä»˜æ¬¾äºº,é¡åˆ¥,é‡‘é¡(JPY),å°å¹£ç´„(TWD),å‚™è¨»\n";
            window.state.expenses.forEach(e => {
                const date = new Date(e.timestamp).toLocaleDateString();
                const user = window.state.users.find(u => u.id === e.userId)?.name || 'Unknown';
                const cat = EXPENSE_CATEGORIES.find(c => c.id === e.cat)?.name || 'å…¶ä»–';
                const twd = Math.round(e.amount / window.state.rate);
                const note = e.note ? `"${e.note.replace(/"/g, '""')}"` : "";
                csvContent += `${date},${user},${cat},${e.amount},${twd},${note}\n`;
            });
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            const url = URL.createObjectURL(blob);
            link.setAttribute("href", url);
            link.setAttribute("download", "æ²–ç¹©è¨˜å¸³_2026.csv");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        async function addCloudExpense(d){if(window.db)await window.expensesRef.add({...d,timestamp:Date.now()});}
        async function updateCloudUser(l){if(window.db)await window.usersRef.set({list:l});}
        async function addCloudItineraryEvent(d,v){if(window.db)await window.itineraryRef.add({...v,dayIndex:d});}
        async function addCloudBackupEvent(v){if(window.db)await window.backupRef.add({...v,timestamp:Date.now()});}
        async function deleteCloudItin(id){if(window.db)await window.itineraryRef.doc(id).delete();}
        async function deleteCloudBackup(id){if(window.db)await window.backupRef.doc(id).delete();}
        async function deleteCloudExpense(id){if(window.db)await window.expensesRef.doc(id).delete();}
    </script>
</body>
</html>


